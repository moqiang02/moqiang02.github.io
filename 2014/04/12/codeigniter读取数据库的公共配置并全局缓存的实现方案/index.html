<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codeigniter读取数据库的公共配置并全局缓存的实现方案 | 自强不息</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="引言学习CodeIgniter大概有几天了。从第一天了解后，对CI情有独钟，比较符合我的风格。其实一直以来对框架这块不太敏感。自己长时间的开发，也有一套自己的开发风格和习惯。但是这年头，你说你不会框架，你都不好意思说你是做开发的。所以就选择一个框架来弥补这个缺点了。去年也接触过thinkPHP，但是对于分组这块，始终感觉理解和掌握不到位，由于时间关系，也就没有深入下去。这次也是因为在国庆节前有位客">
<meta property="og:type" content="article">
<meta property="og:title" content="codeigniter读取数据库的公共配置并全局缓存的实现方案">
<meta property="og:url" content="http://moqiang02.github.io/2014/04/12/codeigniter%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%85%A8%E5%B1%80%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="自强不息">
<meta property="og:description" content="引言学习CodeIgniter大概有几天了。从第一天了解后，对CI情有独钟，比较符合我的风格。其实一直以来对框架这块不太敏感。自己长时间的开发，也有一套自己的开发风格和习惯。但是这年头，你说你不会框架，你都不好意思说你是做开发的。所以就选择一个框架来弥补这个缺点了。去年也接触过thinkPHP，但是对于分组这块，始终感觉理解和掌握不到位，由于时间关系，也就没有深入下去。这次也是因为在国庆节前有位客">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2014-04-12T03:15:53.000Z">
<meta property="article:modified_time" content="2022-10-26T09:28:53.945Z">
<meta property="article:author" content="moqiang">
<meta property="article:tag" content="CI">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">自强不息</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://moqiang02.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-codeigniter读取数据库的公共配置并全局缓存的实现方案" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2014/04/12/codeigniter%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%85%A8%E5%B1%80%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/" class="article-date">
  <time class="dt-published" datetime="2014-04-12T03:15:53.000Z" itemprop="datePublished">2014-04-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      codeigniter读取数据库的公共配置并全局缓存的实现方案
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      

          <!-- rex -->
          

        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>学习CodeIgniter大概有几天了。从第一天了解后，对CI情有独钟，比较符合我的风格。其实一直以来对框架这块不太敏感。自己长时间的开发，也有一套自己的开发风格和习惯。但是这年头，你说你不会框架，你都不好意思说你是做开发的。所以就选择一个框架来弥补这个缺点了。去年也接触过thinkPHP，但是对于分组这块，始终感觉理解和掌握不到位，由于时间关系，也就没有深入下去。这次也是因为在国庆节前有位客户要求用框架开发。所以，也到了不得不掌握一门框架的地步了。于是国庆期间，在家偶尔看了一下官方文档，甚是喜欢。这不，为了一展身手，决定将以前的一个项目转为CI框架模式。一切顺利，只是有一个问题让我一时无法解决，于是在“CI中国论坛”上求助，经过百度与GOOGLE的帮助，终于解决了这个心病，于是在此做个记录，以做纪念。</p>
<span id="more"></span>
<h3 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h3><p>在一般的开发模式中，网站都有一个全局配置，而正常情况下，这些配置都保存在数据库中的一个表中。我的项目是通过一个公共文件里，从数据库表中读取配置信息，并存到缓存中（memcache），在需要的位置都包含这个文件，也就是说，只要第一次从数据库读取数据，那么该数据就被缓存了，以后就可以直接在缓存中取数据，而不需要每次读数据库。除非该缓存已清空（机器重启的情况下）。</p>
<p>这个公共文件内容如下（为了节约篇幅，代码做了修改，只体现这个思路）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mem</span>=new Memcache;  </span><br><span class="line"><span class="variable">$mem</span>-&gt;connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">11211</span>);  </span><br><span class="line"><span class="variable">$_config_arr</span>=<span class="variable">$mem</span>-&gt;get(<span class="string">&#x27;config&#x27;</span>);  </span><br><span class="line"><span class="regexp">//</span><span class="variable">$_config_arr</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span>(!is_array(<span class="variable">$_config_arr</span>))&#123;  </span><br><span class="line">  <span class="regexp">//</span>从数据库读取配置文件  </span><br><span class="line">  <span class="variable">$query</span>=mysql_query(<span class="string">&#x27;select webname,domain,default_lang from config where id=1&#x27;</span>);  </span><br><span class="line">  <span class="keyword">if</span>(mysql_num_rows(<span class="variable">$query</span>))&#123;  </span><br><span class="line">    <span class="variable">$arr</span>=mysql_fetch_array(<span class="variable">$query</span>);  </span><br><span class="line">    <span class="variable">$mem</span>-&gt;set(<span class="string">&#x27;config&#x27;</span>,<span class="variable">$arr</span>,<span class="number">0</span>,<span class="number">0</span>);  </span><br><span class="line">    <span class="variable">$_config_arr</span>=<span class="variable">$mem</span>-&gt;get(<span class="string">&#x27;config&#x27;</span>);  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$_config_arr</span>))&#123;  </span><br><span class="line">  <span class="variable">$_webname</span>=<span class="variable">$_config_arr</span>[webname];  </span><br><span class="line">  <span class="variable">$_domain</span>=<span class="variable">$_config_arr</span>[domain];  </span><br><span class="line">  <span class="variable">$_default_lang</span>=<span class="variable">$_config_arr</span>[default_lang];  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h3 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h3><p>那么在CI中我该如何实现呢？</p>
<p>可能想到的有几个办法，但这些办法要么行不通，要么太繁琐。</p>
<p>1、在入口文件index.php中实现。后了解，在此文件中实现无法加载数据库。总不能单独写个连接数据库这样的东西吧，就跟一坨屎一样。</p>
<p>2、在helper中写，helper其实就是 include，但是helper仍然在数据库加载之前就已加载。</p>
<p>3、写一个模型中，然后自动加载该模型，并在模型中将数据写到缓存中？</p>
<p>4、疯狂百度GOOGLE中….</p>
<p>在“CI中国论坛”了解到，CI只支持memcached，而不支持memcache，而memcached是在unix中的，windows系统上只有memcache。而遗憾的是，我用的就是windows，犹如晴天霹雳。我想，如果CI不支持，也只有通过$mem=new Memcache;这样的方式写了。就是感觉别扭。幸好，找到了解决办法。具体访问：</p>
<p>CI system/libraries/Cache/drivers/memcached.php 兼容 memcache,memcached扩展</p>
<p>解决了CI不支持memcache的问题。解决方案：将上面链接中的代码整理好覆盖原文件内容。（为什么要整理？如果直接复制，由于网页原因，有一段本是注释程序却未被注释，将会导致出错。本篇末尾提供memcached.php代码，你也可以直接拷贝并替换原文件。）</p>
<p>5、发贴寻求帮助，在尝试测试下终于理顺思路，解决如本篇文章标题所示的问题。在此提供解决方案，欢迎交流，如果有更好方案，也希望与我分享。感谢。</p>
<h3 id="寻求帮助"><a href="#寻求帮助" class="headerlink" title="寻求帮助"></a>寻求帮助</h3><p>网友提供帮助内容如下：</p>
<blockquote>
<p>通过扩展CI_Controller类，增加一个或多个方法，这样在所有的控制器都可以使用这些方法了，就像公用方法了。在这些方法中对数据库进行操作。<br>例如<br>MY_Controller类继承于CI_Controller，你的控制器继承于MY_Controller。在MY_Controller中增加个options方法,这个方法对数据库进行操作,以后在每个控制器的方法中都可以使用options()方法获取你需要的信息了。<br>(扩展核心类)请看手册,恕我无法一一细说:<a target="_blank" rel="noopener" href="http://codeigniter.org.cn/user_guide/general/core_classes.html">http://codeigniter.org.cn/user_guide/general/core_classes.html</a>  </p>
</blockquote>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>我的解决方案是：扩展CI_Controller类（文件名：MY_Controller），在该类的构造函数中读取数据库的表的配置信息。将信息通过$this-&gt;load-&gt;vars($data);设为全局变量。这样只要加载视图，无需传递该$data值即可使用$data里的所有变量信息。（$data是一对象）</p>
<h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h3><p>MY_Controller代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ( ! <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;BASEPATH&#x27;</span>)) <span class="keyword">exit</span>(<span class="string">&#x27;No direct script access allowed&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MY_Controller</span> <span class="keyword">extends</span> <span class="title">CI_Controller</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">driver</span>(<span class="string">&#x27;cache&#x27;</span>);  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">model</span>(<span class="string">&#x27;manager_model&#x27;</span>);  </span><br><span class="line">          </span><br><span class="line">        <span class="variable">$_config_arr</span>=<span class="variable language_">$this</span>-&gt;cache-&gt;memcached-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;config&#x27;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_object</span>(<span class="variable">$_config_arr</span>))&#123;  </span><br><span class="line">            <span class="variable">$_config_arr</span>=<span class="variable language_">$this</span>-&gt;manager_model-&gt;<span class="title function_ invoke__">get_config</span>();  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cache-&gt;memcached-&gt;<span class="title function_ invoke__">save</span>(<span class="string">&#x27;config&#x27;</span>,<span class="variable">$_config_arr</span>,<span class="number">0</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_object</span>(<span class="variable">$_config_arr</span>))&#123;  </span><br><span class="line">          <span class="variable">$data</span>[<span class="string">&#x27;_webname&#x27;</span>]=<span class="variable">$_config_arr</span>-&gt;webname;  </span><br><span class="line">          <span class="variable">$data</span>[<span class="string">&#x27;_domain&#x27;</span>]=<span class="variable">$_config_arr</span>-&gt;domain;  </span><br><span class="line">          <span class="variable">$data</span>[<span class="string">&#x27;_default_lang&#x27;</span>]=<span class="variable">$_config_arr</span>-&gt;default_lang;  </span><br><span class="line">          <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">vars</span>(<span class="variable">$data</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>manager_model模型中get_config()方法代码如下：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function get_config()&#123;  </span><br><span class="line">    $<span class="function"><span class="title">query</span> = $this-&gt;</span><span class="function"><span class="title">db</span>-&gt;</span>query(<span class="string">&#x27;select id,webname,domain,default_lang from config where id=1&#x27;</span>);  </span><br><span class="line">    <span class="function"><span class="title">if</span>($query-&gt;</span>num_rows())  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="function"><span class="title">return</span> $query-&gt;</span>row();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>控制器中加载config.php视图方法如下：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    $this-&gt;load-&gt;view(<span class="string">&#x27;public/config&#x27;</span>);<span class="comment">//这里无需传递第二个参数。  </span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>config方法中，如果有其它参数，也以通过第二个参数传递。不影响传递$data的值。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">    <span class="variable">$data1</span>[<span class="string">&#x27;title&#x27;</span>]=<span class="string">&#x27;这是标题&#x27;</span>;  </span><br><span class="line">    <span class="variable">$data1</span>[<span class="string">&#x27;keyword&#x27;</span>]=<span class="string">&#x27;这是关键字&#x27;</span>;  </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">view</span>(<span class="string">&#x27;public/config&#x27;</span>,<span class="variable">$data1</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>在视图public/config.php文件中，即可以使用$data中所有变量，也可以使用$title和$keyword变量。</p>
<h3 id="相关问题描述"><a href="#相关问题描述" class="headerlink" title="相关问题描述"></a>相关问题描述</h3><p>CodeIgniter 用户指南 版本 2.1.0 关于Memcached缓存的使用说明</p>
<blockquote>
<p>Memcached 缓存<br>使用分布式 Memcached 服务器 可以通过配置文件： memcached.php 来配置,该文件在 application/config/ 目录下.<br>All of the functions listed above can be accessed without passing a specific adapter to the driver loader as follows:<br>$this-&gt;load-&gt;driver(‘cache’);<br>$this-&gt;cache-&gt;memcached-&gt;save(‘foo’, ‘bar’, 10);<br>若想了解更多关于 Memcached的信息, 请参考 <a target="_blank" rel="noopener" href="http://php.net/memcached">http://php.net/memcached</a>  </p>
</blockquote>
<p>来源：<a target="_blank" rel="noopener" href="http://codeigniter.org.cn/user_guide/drivers/caching.html#dummy">http://codeigniter.org.cn/user_guide/drivers/caching.html#dummy</a></p>
<p>我的CodeIgniter 版本 2.1.2，却在application/config中找不到memcached.php这个配置文件</p>
<p>其实，需要手工在该目录创建，内容默认如下：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$config[<span class="string">&#x27;memcached&#x27;</span>] = <span class="keyword">array</span>(  </span><br><span class="line">    <span class="string">&#x27;hostname&#x27;</span>  =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;port&#x27;</span>      =&gt; <span class="number">11211</span>,  </span><br><span class="line">    <span class="string">&#x27;weight&#x27;</span>    =&gt; <span class="number">1</span>  </span><br><span class="line">);  </span><br></pre></td></tr></table></figure>
<p>说明：上面的“Cache_memcached.php”中已经有默认的值，该值与上面这个配置文件内容相同。如果你的设置与默认值恰好相同，也可以不用建立memcached.php这个配置文件。如果不同，你也可以直接更改 Cache_memcached.php 文件中的配置值。但是，你一旦建立memcached.php这个配置文件，那么该值将会覆盖 Cache_memcached.php 中的默认值。<br>Cache_memcached.php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ( ! <span class="title function_ invoke__">defined</span>(<span class="string">&#x27;BASEPATH&#x27;</span>)) <span class="keyword">exit</span>(<span class="string">&#x27;No direct script access allowed&#x27;</span>);  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * CodeIgniter </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * An open source application development framework for PHP 4.3.2 or newer </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>  CodeIgniter </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  ExpressionEngine Dev Team </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span> Copyright (c) 2006 - 2012 EllisLab, Inc. </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>  http://codeigniter.com/user_guide/license.html </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span>  http://codeigniter.com </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>  Version 2.0 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@filesource</span> </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * CodeIgniter Memcached Caching Class </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>  CodeIgniter </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@subpackage</span> Libraries </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@category</span> Core </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  ExpressionEngine Dev Team </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CI_Cache_memcached</span> <span class="keyword">extends</span> <span class="title">CI_Driver</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line"> <span class="keyword">private</span> <span class="variable">$_memcached</span>; <span class="comment">// Holds the memcached object  </span></span><br><span class="line">  </span><br><span class="line"> <span class="keyword">protected</span> <span class="variable">$_memcache_conf</span>  = <span class="keyword">array</span>(  </span><br><span class="line">      <span class="string">&#x27;default&#x27;</span> =&gt; <span class="keyword">array</span>(  </span><br><span class="line">      <span class="string">&#x27;default_host&#x27;</span>  =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,  </span><br><span class="line">      <span class="string">&#x27;default_port&#x27;</span>  =&gt; <span class="number">11211</span>,  </span><br><span class="line">      <span class="string">&#x27;default_weight&#x27;</span> =&gt; <span class="number">1</span>  </span><br><span class="line">     )  </span><br><span class="line">    );  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Fetch from cache </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  mixed  unique key id </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  mixed  data on success/false on failure </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$id</span></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$id</span>);  </span><br><span class="line">  <span class="keyword">return</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) ? <span class="variable">$data</span>[<span class="number">0</span>] : <span class="literal">FALSE</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Save </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  string  unique identifier </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  mixed  data being cached </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  int   time to live </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  boolean  true on success, false on failure </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$data</span>, <span class="variable">$ttl</span> = <span class="number">60</span></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;_memcached) == <span class="string">&#x27;Memcached&#x27;</span>)  </span><br><span class="line">  &#123;  </span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$id</span>, <span class="keyword">array</span>(<span class="variable">$data</span>, <span class="title function_ invoke__">time</span>(), <span class="variable">$ttl</span>), <span class="variable">$ttl</span>);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;_memcached) == <span class="string">&#x27;Memcache&#x27;</span>)  </span><br><span class="line">  &#123;  </span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$id</span>, <span class="keyword">array</span>(<span class="variable">$data</span>, <span class="title function_ invoke__">time</span>(), <span class="variable">$ttl</span>), <span class="number">0</span>, <span class="variable">$ttl</span>);  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">FALSE</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Delete from Cache </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  mixed  key to be deleted. </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  boolean  true on success, false on failure </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$id</span></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$id</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Clean the Cache </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  boolean  false on failure/true on success </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">flush</span>();  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Cache Info </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  null  type not supported in memcached </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  mixed   array on success, false on failure </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_info</span>(<span class="params"><span class="variable">$type</span> = <span class="literal">NULL</span></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">getStats</span>();  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Get Cache Metadata </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span>  mixed  key to get cache metadata on </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>  mixed  FALSE on failure, array on success. </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_metadata</span>(<span class="params"><span class="variable">$id</span></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="variable">$stored</span> = <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$id</span>);  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$stored</span>) !== <span class="number">3</span>)  </span><br><span class="line">  &#123;  </span><br><span class="line">   <span class="keyword">return</span> <span class="literal">FALSE</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">list</span>(<span class="variable">$data</span>, <span class="variable">$time</span>, <span class="variable">$ttl</span>) = <span class="variable">$stored</span>;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">array</span>(  </span><br><span class="line">   <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="variable">$time</span> + <span class="variable">$ttl</span>,  </span><br><span class="line">   <span class="string">&#x27;mtime&#x27;</span>  =&gt; <span class="variable">$time</span>,  </span><br><span class="line">   <span class="string">&#x27;data&#x27;</span>  =&gt; <span class="variable">$data</span>  </span><br><span class="line">  );  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Setup memcached. </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_setup_memcached</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  <span class="comment">// Try to load memcached server info from the config file.  </span></span><br><span class="line">  <span class="variable">$CI</span> =&amp; <span class="title function_ invoke__">get_instance</span>();  </span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$CI</span>-&gt;config-&gt;<span class="title function_ invoke__">load</span>(<span class="string">&#x27;memcached&#x27;</span>, <span class="literal">TRUE</span>, <span class="literal">TRUE</span>))  </span><br><span class="line">  &#123;  </span><br><span class="line">   <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$CI</span>-&gt;config-&gt;config[<span class="string">&#x27;memcached&#x27;</span>]))  </span><br><span class="line">   &#123;  </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_memcache_conf = <span class="literal">NULL</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$CI</span>-&gt;config-&gt;config[<span class="string">&#x27;memcached&#x27;</span>] <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$conf</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">     <span class="variable language_">$this</span>-&gt;_memcache_conf[<span class="variable">$name</span>] = <span class="variable">$conf</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;memcached&#x27;</span>))&#123;  </span><br><span class="line">   <span class="variable language_">$this</span>-&gt;_memcached = <span class="keyword">new</span> <span class="title class_">Memcached</span>();  </span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">   <span class="variable language_">$this</span>-&gt;_memcached = <span class="keyword">new</span> <span class="title class_">Memcache</span>();  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"> <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_memcache_conf <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$cache_server</span>)  </span><br><span class="line"> &#123;  </span><br><span class="line">           <span class="keyword">if</span> ( ! <span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;hostname&#x27;</span>, <span class="variable">$cache_server</span>))  </span><br><span class="line">            &#123;  </span><br><span class="line">  </span><br><span class="line">               <span class="comment">// $cache_server[&#x27;hostname&#x27;] = $this-&gt;_default_options[&#x27;default_host&#x27;]; //坑爹的原代码,没有_default_options属性  </span></span><br><span class="line">                <span class="variable">$cache_server</span>[<span class="string">&#x27;hostname&#x27;</span>] = <span class="variable language_">$this</span>-&gt;_memcache_conf[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;default_host&#x27;</span>];  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> ( ! <span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;port&#x27;</span>, <span class="variable">$cache_server</span>))  </span><br><span class="line">            &#123;  </span><br><span class="line">  </span><br><span class="line">               <span class="comment">// $cache_server[&#x27;port&#x27;] = $this-&gt;_default_options[&#x27;default_port&#x27;];//坑爹的原代码,没有_default_options属性  </span></span><br><span class="line">                <span class="variable">$cache_server</span>[<span class="string">&#x27;port&#x27;</span>] = <span class="variable language_">$this</span>-&gt;_memcache_conf[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;default_port&#x27;</span>];  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> ( ! <span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;weight&#x27;</span>, <span class="variable">$cache_server</span>))  </span><br><span class="line">            &#123;  </span><br><span class="line">  </span><br><span class="line">              <span class="comment">//  $cache_server[&#x27;weight&#x27;] = $this-&gt;_default_options[&#x27;default_weight&#x27;];//坑爹的原代码,没有_default_options属性  </span></span><br><span class="line">                <span class="variable">$cache_server</span>[<span class="string">&#x27;weight&#x27;</span>] = <span class="variable language_">$this</span>-&gt;_memcache_conf[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;default_weight&#x27;</span>];  </span><br><span class="line">            &#125;  </span><br><span class="line">             <span class="comment">//导致如果不配置 config/memcache.php文件，执行到$this-&gt;_memcached-&gt;addServer($cache_server[&#x27;hostname&#x27;],$cache_server[&#x27;port&#x27;]);出错（因为此时语句，相当于$this-&gt;_memcached-&gt;addServer(‘’,&#x27;&#x27;);然后机器木反应了~  </span></span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;memcached&#x27;</span>))&#123;  </span><br><span class="line">                <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">addServer</span>(  </span><br><span class="line">                    <span class="variable">$cache_server</span>[<span class="string">&#x27;hostname&#x27;</span>], <span class="variable">$cache_server</span>[<span class="string">&#x27;port&#x27;</span>], <span class="variable">$cache_server</span>[<span class="string">&#x27;weight&#x27;</span>]  </span><br><span class="line">                );  </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                <span class="variable language_">$this</span>-&gt;_memcached-&gt;<span class="title function_ invoke__">addServer</span>(<span class="variable">$cache_server</span>[<span class="string">&#x27;hostname&#x27;</span>],<span class="variable">$cache_server</span>[<span class="string">&#x27;port&#x27;</span>],<span class="literal">TRUE</span>, <span class="variable">$cache_server</span>[<span class="string">&#x27;weight&#x27;</span>]);  </span><br><span class="line">            &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Is supported </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * Returns FALSE if memcached is not supported on the system. </span></span><br><span class="line"><span class="comment">  * If it is, we setup the memcached object &amp; return TRUE </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_supported</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ( !<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;memcached&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;memcache&#x27;</span>))  </span><br><span class="line">  &#123;  </span><br><span class="line">   <span class="title function_ invoke__">log_message</span>(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;The Memcached Extension must be loaded to use Memcached Cache.&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">   <span class="keyword">return</span> <span class="literal">FALSE</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_setup_memcached</span>();  </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">TRUE</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">// ------------------------------------------------------------------------  </span></span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// End Class  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">/* End of file Cache_memcached.php */</span>  </span><br><span class="line"><span class="comment">/* Location: ./system/libraries/Cache/drivers/Cache_memcached.php */</span>  </span><br></pre></td></tr></table></figure>

<h3 id="代码分析摘要"><a href="#代码分析摘要" class="headerlink" title="代码分析摘要"></a>代码分析摘要</h3><p>一、memcached-&gt;addServer与memcache-&gt;addServer区别</p>
<p><a target="_blank" rel="noopener" href="http://www.php.net/manual/zh/memcached.addserver.php">http://www.php.net/manual/zh/memcached.addserver.php</a></p>
<p><a target="_blank" rel="noopener" href="http://www.php.net/manual/zh/memcache.addserver.php">http://www.php.net/manual/zh/memcache.addserver.php</a><br>二、与原文件改动部分</p>
<p>1、_setup_memcached()方法修改</p>
<p>原内容：（因为只考虑了memcached）</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in">this</span>-&gt;_memcached = <span class="keyword">new</span> <span class="type">Memcached</span>();  </span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (extension_loaded(<span class="string">&#x27;memcached&#x27;</span>))&#123;  </span><br><span class="line">  $<span class="built_in">this</span>-&gt;_memcached = <span class="keyword">new</span> <span class="type">Memcached</span>();  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">  $<span class="built_in">this</span>-&gt;_memcached = <span class="keyword">new</span> <span class="type">Memcache</span>();  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>2、原类中没有_default_options属性</p>
<p>由于没有_default_options属性，所以导致_setup_memcached()方法中所有关于此句的代码都要换个方式。也可以建立个_default_options属性。上面代码中是将</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$cac</span>he_server[<span class="string">&#x27;hostname&#x27;</span>] = <span class="symbol">$t</span>his-&gt;_default_options[<span class="string">&#x27;default_host&#x27;</span>];  </span><br></pre></td></tr></table></figure>
<p>更改为</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$cache_server[<span class="string">&#x27;hostname&#x27;</span>] = $this-&gt;<span class="symbol">_memcache_conf</span>[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;default_host&#x27;</span>];  </span><br></pre></td></tr></table></figure>
<p>还包括port 和 weight的取值。</p>
<p>3、is_supported() 方法</p>
<p>将原内容：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ( ! extension_loaded(&#x27;memcached&#x27;))  </span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ( !extension_loaded(&#x27;memcached&#x27;) <span class="symbol">&amp;&amp;</span> !extension_loaded(&#x27;memcache&#x27;))  </span><br></pre></td></tr></table></figure>
<p>这些改动内容都不用多做解释。在这只是将改动部分与原内容做一个说明。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://moqiang02.github.io/2014/04/12/codeigniter%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%85%A8%E5%B1%80%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/" data-id="cl9pgeo000179ycv18o7070z5" data-title="codeigniter读取数据库的公共配置并全局缓存的实现方案" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI/" rel="tag">CI</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/04/13/%E8%B0%88PHP%E4%B8%AD%E7%9A%84%E9%92%A9%E5%AD%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          谈PHP中的钩子
        
      </div>
    </a>
  
  
    <a href="/2014/04/11/php%E9%94%81%E5%AE%9A%E6%96%87%E6%9C%AC%E6%A1%86%E5%86%85%E5%AE%B9%E7%9A%84%E6%96%B9%E6%B3%95/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">php锁定文本框内容的方法(disabled/readonly的区别)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">255</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/apache/">apache</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/flutter/">flutter</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github%E5%8D%9A%E5%AE%A2/">github博客</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html-css/">html+css</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iis/">iis</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">114</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">72</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">41</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs/">nodejs</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">185</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E5%AE%83/">其它</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">47</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/">开源项目</a><span class="category-list-count">73</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/">生活随笔</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/">量化交易</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AndroidStudio/" style="font-size: 13.75px;">AndroidStudio</a> <a href="/tags/AndroidUI/" style="font-size: 20px;">AndroidUI</a> <a href="/tags/Android%E4%BA%8B%E4%BB%B6%E6%8B%A6%E6%88%AA/" style="font-size: 11.25px;">Android事件拦截</a> <a href="/tags/Android%E5%BC%80%E6%BA%90/" style="font-size: 18.75px;">Android开源</a> <a href="/tags/CI/" style="font-size: 15.63px;">CI</a> <a href="/tags/CURL/" style="font-size: 13.13px;">CURL</a> <a href="/tags/DEDE/" style="font-size: 19.38px;">DEDE</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/Flask/" style="font-size: 10.63px;">Flask</a> <a href="/tags/JavaSE/" style="font-size: 16.88px;">JavaSE</a> <a href="/tags/Laravel/" style="font-size: 18.75px;">Laravel</a> <a href="/tags/Maven/" style="font-size: 10.63px;">Maven</a> <a href="/tags/SVN/" style="font-size: 10px;">SVN</a> <a href="/tags/SpringBoot/" style="font-size: 17.5px;">SpringBoot</a> <a href="/tags/Thinkphp/" style="font-size: 10px;">Thinkphp</a> <a href="/tags/UEditor/" style="font-size: 11.88px;">UEditor</a> <a href="/tags/VMware/" style="font-size: 12.5px;">VMware</a> <a href="/tags/Vue/" style="font-size: 18.75px;">Vue</a> <a href="/tags/WebSocket/" style="font-size: 13.13px;">WebSocket</a> <a href="/tags/ecshop/" style="font-size: 15px;">ecshop</a> <a href="/tags/scrapy/" style="font-size: 14.38px;">scrapy</a> <a href="/tags/smarty/" style="font-size: 12.5px;">smarty</a> <a href="/tags/socket/" style="font-size: 15px;">socket</a> <a href="/tags/sphinx/" style="font-size: 11.88px;">sphinx</a> <a href="/tags/vagrant/" style="font-size: 12.5px;">vagrant</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 11.25px;">微服务</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" style="font-size: 15.63px;">数据传输</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 11.88px;">正则</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 16.25px;">消息队列</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 17.5px;">爬虫</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 18.13px;">集群</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/11/27/Java%E6%95%99%E7%A8%8B%E7%B4%A2%E5%BC%95/">Java教程索引</a>
          </li>
        
          <li>
            <a href="/2022/11/01/Java8%E4%B8%AD%E4%BD%BF%E7%94%A8Optional%E5%A4%84%E7%90%86null%E5%AF%B9%E8%B1%A1/">Java8中使用Optional处理null对象</a>
          </li>
        
          <li>
            <a href="/2022/11/01/Java%E6%B3%9B%E5%9E%8B%E8%AF%A6%E8%A7%A3/">Java泛型详解</a>
          </li>
        
          <li>
            <a href="/2022/10/26/java%E4%B8%ADMap%E5%8F%8AMap-Entry%E8%AF%A6%E8%A7%A3/">java中Map及Map.Entry详解</a>
          </li>
        
          <li>
            <a href="/2022/10/23/spring-boot-redis-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%88pub-sub%E5%92%8Cstream%EF%BC%89/">spring boot redis 消息队列（pub/sub和stream）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 moqiang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>

<!-- rex -->

<script src="/js/toc.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>