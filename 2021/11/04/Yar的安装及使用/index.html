<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Yar的安装及使用 | 自强不息</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Yar 是一个轻量级, 高效的RPC框架, 它提供了一种简单方法来让PHP项目之间可以互相远程调用对方的本地方法. 并且Yar也提供了并行调用的能力. 可以支持同时调用多个远程服务的方法.">
<meta property="og:type" content="article">
<meta property="og:title" content="Yar的安装及使用">
<meta property="og:url" content="http://moqiang02.github.io/2021/11/04/Yar%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="自强不息">
<meta property="og:description" content="Yar 是一个轻量级, 高效的RPC框架, 它提供了一种简单方法来让PHP项目之间可以互相远程调用对方的本地方法. 并且Yar也提供了并行调用的能力. 可以支持同时调用多个远程服务的方法.">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-11-04T12:04:32.000Z">
<meta property="article:modified_time" content="2022-10-26T09:28:53.925Z">
<meta property="article:author" content="moqiang">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">自强不息</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://moqiang02.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Yar的安装及使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/04/Yar%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2021-11-04T12:04:32.000Z" itemprop="datePublished">2021-11-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Yar的安装及使用
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      

          <!-- rex -->
          
            <!-- 文章目录开始 -->
            
              <div id="toc" class="toc-article">
              <strong class="toc-title" style="cursor:pointer">目录</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Yar%E6%89%A9%E5%B1%95"><span class="toc-number">1.1.</span> <span class="toc-text">安装Yar扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-yar"><span class="toc-number">1.2.</span> <span class="toc-text">安装 yar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">PHP扩展配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.</span> <span class="toc-text">添加扩展配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="toc-number">1.5.</span> <span class="toc-text">添加软链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thinkphp%E4%BD%BF%E7%94%A8yar"><span class="toc-number">4.</span> <span class="toc-text">thinkphp使用yar</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#thinkphp5-0%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.</span> <span class="toc-text">thinkphp5.0版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#thinphp5-1-%E6%A1%86%E6%9E%B6%E5%B7%B2%E7%BB%8F%E7%A7%BB%E9%99%A4yar%EF%BC%8C%E9%9C%80%E8%87%AA%E5%B7%B1%E6%B7%BB%E5%8A%A0%E2%80%9D-thinphp5-1-%E6%A1%86%E6%9E%B6%E5%B7%B2%E7%BB%8F%E7%A7%BB%E9%99%A4yar%EF%BC%8C%E9%9C%80%E8%87%AA%E5%B7%B1%E6%B7%BB%E5%8A%A0"><span class="toc-number">4.2.</span> <span class="toc-text">thinphp5.1 框架已经移除yar，需自己添加”)thinphp5.1 框架已经移除yar，需自己添加</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E7%89%88%E6%9C%AC%E4%B8%80%E5%AE%9A%E8%A6%81-7-0%E4%BB%A5%E4%B8%8A%E7%9A%84"><span class="toc-number">5.1.</span> <span class="toc-text">php版本一定要 7.0以上的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-Fatal-error-Yar-Client-call-unsupported-packager-msgpack"><span class="toc-number">5.2.</span> <span class="toc-text">PHP Fatal error: Yar_Client::__call(): unsupported packager msgpack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%EF%BC%9A-php-msgpack-unserialize-Extra-bytes-in-xxx"><span class="toc-number">5.3.</span> <span class="toc-text">报错： (php_msgpack_unserialize) Extra bytes in xxx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98"><span class="toc-number">5.4.</span> <span class="toc-text">超时问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%AC%A1%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98"><span class="toc-number">5.5.</span> <span class="toc-text">多次请求问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="toc-number">6.</span> <span class="toc-text">扩展知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yar%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.</span> <span class="toc-text">yar运行时的默认配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yar%E5%B8%B8%E9%87%8F"><span class="toc-number">6.2.</span> <span class="toc-text">yar常量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%96%B9%E6%B3%95"><span class="toc-number">6.3.</span> <span class="toc-text">基本方法</span></a></li></ol></li></ol>
              </div>
            
            <!-- 文章目录结束 -->	  
          

        <p>Yar 是一个轻量级, 高效的RPC框架, 它提供了一种简单方法来让PHP项目之间可以互相远程调用对方的本地方法. 并且Yar也提供了并行调用的能力. 可以支持同时调用多个远程服务的方法.<span id="more"></span></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装Yar扩展"><a href="#安装Yar扩展" class="headerlink" title="安装Yar扩展"></a>安装Yar扩展</h3><p>确认 phpize 是否安装<br><code>$sudo find / -name phpize</code><br>//如果没有安装，可以通过开发版来安装该扩展<br><code>$sudo apt-get install php-dev</code><br>安装 msgpack<br><code>$sudo pecl install msgpack</code></p>
<p>安装成功，提示如下,要求配置php.ini，这里先放一下</p>
<blockquote>
<p>configuration option “php_ini” is not set to php.ini location<br>You should add “extension=msgpack.so” to php.ini</p>
</blockquote>
<h3 id="安装-yar"><a href="#安装-yar" class="headerlink" title="安装 yar"></a>安装 yar</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">$sudo</span> pecl install yar</span></span><br><span class="line">Enable Msgpack Supports [<span class="keyword">no</span>] :  <span class="comment">//填yes or no</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果填no，则默认的打包协议是php(serialize)。如果填yes，则默认的打包传输协议为msgpack。</p>
</blockquote>
<p>错误提示如下：</p>
<blockquote>
<p>configure: error: Please reinstall the libcurl distribution - easy.h should be in /include/curl/<br>ERROR: /tmp/pear/temp/yar/configure –enable-msgpack=yes failed</p>
</blockquote>
<p>可以通过以下命令解决这个问题:<br><code>$sudo apt-get install libcurl4-gnutls-dev</code></p>
<blockquote>
<p>注：在MacOS环境下，这个错绕不过去，<code>brew reinstall curl</code>不行，所以使用编译的方式安装，主要是指定curl的路径。具体步骤：<br>1.<code>git clone https://github.com/laruence/yar.git</code><br>2.<code>cd yar &amp;&amp; phpize</code><br>3.<code>./configure --with-php-config=/usr/local/opt/php/bin/php-config --enable-msgpack=no --with-curl=/usr/local/opt/curl</code><br>4.<code>make &amp;&amp; make install</code></p>
</blockquote>
<p>安装成功，最后提示:</p>
<blockquote>
<p>configuration option “php_ini” is not set to php.ini location<br>You should add “extension=yar.so” to php.ini</p>
</blockquote>
<p>浏览器访问<code>127.0.0.1/test.php</code>，查看php信息并没有看到msgpack和yar，需要进一步配置</p>
<h3 id="PHP扩展配置"><a href="#PHP扩展配置" class="headerlink" title="PHP扩展配置"></a>PHP扩展配置</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> find / -name msgpack.so</span><br><span class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/php/</span><span class="number">20190902</span>/msgpack.so</span><br><span class="line"><span class="variable">$sudo</span> find / -name yar.so</span><br><span class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/php/</span><span class="number">20190902</span>/yar.so</span><br></pre></td></tr></table></figure>

<p>说明msgpack和yar都已经安装成功</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>php<span class="regexp">/7.4/m</span>ods-available</span><br><span class="line"><span class="regexp">//</span>可以看到扩展的配置文件</span><br></pre></td></tr></table></figure>

<h3 id="添加扩展配置文件"><a href="#添加扩展配置文件" class="headerlink" title="添加扩展配置文件"></a>添加扩展配置文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> vi msgpack.ini</span><br><span class="line">; configuration <span class="keyword">for</span> php msgpack module</span><br><span class="line">; <span class="attribute">priority</span>=20</span><br><span class="line"><span class="attribute">extension</span>=msgpack.so</span><br><span class="line"></span><br><span class="line"><span class="variable">$sudo</span> vi yar.ini</span><br><span class="line">; configuration <span class="keyword">for</span> php yar module</span><br><span class="line">; <span class="attribute">priority</span>=40</span><br><span class="line"><span class="attribute">extension</span>=yar.so</span><br></pre></td></tr></table></figure>

<p>注：因为yar依赖于json和msgpack，所以yar的priority的值要大一点</p>
<h3 id="添加软链接"><a href="#添加软链接" class="headerlink" title="添加软链接"></a>添加软链接</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>php<span class="regexp">/7.4/</span>fpm/conf.d</span><br><span class="line">ls -all</span><br></pre></td></tr></table></figure>

<p>可以看到该目录下都是软链接，在该目录下添加上面两个配置文件的软链接</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> ln -s ..<span class="regexp">/../m</span>ods-available/msgpack.ini <span class="number">20</span>-msgpack.ini</span><br><span class="line"><span class="variable">$sudo</span> ln -s ..<span class="regexp">/../m</span>ods-available/yar.ini <span class="number">40</span>-yar.ini</span><br></pre></td></tr></table></figure>

<p>重启Apache，浏览器访问127.0.0.1/test.php查看phpinfo，可以看到已有yar和msgpack，说明配置成功</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>Server端示例(不需要常驻进程):</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">API</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the doc info will be generated automatically into service info page.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@params</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">api</span>(<span class="params"><span class="variable">$parameter</span>, <span class="variable">$option</span> = <span class="string">&quot;foo&quot;</span></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">client_can_not_see</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$service</span> = <span class="keyword">new</span> <span class="title class_">Yar_Server</span>(<span class="keyword">new</span> <span class="title function_ invoke__">API</span>());</span><br><span class="line"><span class="variable">$service</span>-&gt;<span class="title function_ invoke__">handle</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Yar为了方便开发, 把文档和接口绑定到了一起, 对于上面的例子, 如果我们是简单的GET请求这个接口地址的话, 我们就会看到如下的信息页面:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Yar</span> <span class="symbol">Server:</span> <span class="title class_">API</span></span><br><span class="line">+<span class="title class_">API</span>::api(<span class="variable">$parameter</span>, <span class="variable">$option</span> = <span class="string">&#x27;foo&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Client端也很简单，有2种：<br>1)串行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">Yar_Client</span>(<span class="string">&quot;http://host/api/&quot;</span>);</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">api</span>(<span class="string">&quot;parameter&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>2)并行化调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"><span class="variable">$retval</span>, <span class="variable">$callinfo</span></span>) </span>&#123;</span><br><span class="line">     <span class="title function_ invoke__">var_dump</span>(<span class="variable">$retval</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;api&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>);</span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;api&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>);</span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;api&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>);</span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;api&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>);</span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">loop</span>(); <span class="comment">//send</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样, 所有的请求会一次发出, 只要有任何一个请求完成, 回调函数”callback”就会被立即调用.</p>
<p>这里还有一个细节, Yar见缝插针的不会浪费任何时间, 在这些请求发送完成以后, Yar会调用一次callback, 和普通的请求返回回调不同, 这次的调用的<code>$callinfo</code>参数为空.</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>server端：yar.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">API</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * the doc info will be generated automatically into service info page.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@params</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;test2&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$service</span> = <span class="keyword">new</span> <span class="title class_">Yar_Server</span>(<span class="keyword">new</span> <span class="title function_ invoke__">API</span>());</span><br><span class="line"><span class="variable">$service</span>-&gt;<span class="title function_ invoke__">handle</span>();</span><br></pre></td></tr></table></figure>

<p>直接在浏览器打开<a target="_blank" rel="noopener" href="http://localhost/yar.php%E4%BC%9A%E6%98%BE%E7%A4%BAAPI%E6%96%87%E6%A1%A3%E3%80%82">http://localhost/yar.php会显示API文档。</a></p>
<p>client端：yar_client.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//串行调用</span></span><br><span class="line"><span class="comment">//$client = new Yar_Client(&quot;http://localhost/yar.php&quot;);</span></span><br><span class="line"><span class="comment">//$client-&gt;test();</span></span><br><span class="line"><span class="comment">//$client-&gt;test2();</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"><span class="variable">$retval</span>, <span class="variable">$callinfo</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//var_dump($retval);</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="title function_ invoke__">time</span>().<span class="string">&#x27;:callinfo:&#x27;</span>.<span class="title function_ invoke__">json_encode</span>(<span class="variable">$callinfo</span>).PHP_EOL, <span class="number">3</span>, <span class="string">&#x27;t.log&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$callinfo</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">       <span class="comment">//做本地的逻辑</span></span><br><span class="line">       <span class="comment">//return TRUE;</span></span><br><span class="line">       <span class="title function_ invoke__">error_log</span>(<span class="title function_ invoke__">time</span>().<span class="string">&#x27;:&#x27;</span>.<span class="string">&#x27;send req success&#x27;</span>.PHP_EOL, <span class="number">3</span>, <span class="string">&#x27;t.log&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">error_log</span>(<span class="title function_ invoke__">time</span>().<span class="string">&#x27;:&#x27;</span>.<span class="variable">$retval</span>.PHP_EOL, <span class="number">3</span>, <span class="string">&#x27;t.log&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback2</span>(<span class="params"><span class="variable">$retval</span>, <span class="variable">$callinfo</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error_callback</span>(<span class="params"><span class="variable">$type</span>, <span class="variable">$error</span>, <span class="variable">$callinfo</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="variable">$error</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//并行调用：</span></span><br><span class="line"><span class="comment">//1、所有请求发送成功，Yar会调用一次callback，其中$callinfo为null</span></span><br><span class="line"><span class="comment">//2、每个请求执行完成，获取到了结果，也会去调用callback，其中$callinfo不为null</span></span><br><span class="line"><span class="variable">$res</span> = <span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://localhost/yar.php&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$res1</span> = <span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://localhost/yar.php&quot;</span>, <span class="string">&quot;test2&quot;</span>);</span><br><span class="line"><span class="variable">$res2</span> = <span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">loop</span>(<span class="string">&quot;callback&quot;</span>, <span class="string">&quot;error_callback&quot;</span>);  <span class="comment">//send</span></span><br></pre></td></tr></table></figure>

<p>t.log:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1472832899</span><span class="symbol">:callinfo</span><span class="symbol">:null</span></span><br><span class="line"><span class="number">1472832899</span><span class="symbol">:send</span> req success</span><br><span class="line"><span class="number">1472832900</span><span class="symbol">:callinfo</span><span class="symbol">:</span>&#123;<span class="string">&quot;sequence&quot;</span><span class="symbol">:</span><span class="number">1</span>,<span class="string">&quot;uri&quot;</span><span class="symbol">:<span class="string">&quot;http:\/\/localhost\/yar.php&quot;</span></span>,<span class="string">&quot;method&quot;</span><span class="symbol">:<span class="string">&quot;test&quot;</span></span>&#125;</span><br><span class="line"><span class="number">1472832900</span><span class="symbol">:t</span></span><br><span class="line"><span class="number">1472832902</span><span class="symbol">:callinfo</span><span class="symbol">:</span>&#123;<span class="string">&quot;sequence&quot;</span><span class="symbol">:</span><span class="number">2</span>,<span class="string">&quot;uri&quot;</span><span class="symbol">:<span class="string">&quot;http:\/\/localhost\/yar.php&quot;</span></span>,<span class="string">&quot;method&quot;</span><span class="symbol">:<span class="string">&quot;test2&quot;</span></span>&#125;</span><br><span class="line"><span class="number">1472832902</span><span class="symbol">:test2</span></span><br></pre></td></tr></table></figure>

<p>log验证了yar的执行过程。那么，实际应用中，我们就可以先发送请求, 请求发送完毕，然后得到第一次回调（<code>$callinfo</code>为null）, 继续做我们当前进程的工作; 等所有工作结束以后, 再交给Yar去获取并行RPC的响应：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"><span class="variable">$retval</span>, <span class="variable">$callinfo</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$callinfo</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//请求发送完毕，会运行到这里</span></span><br><span class="line">        <span class="comment">//做本地的逻辑</span></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//RPC请求返回, callback会再次调用。返回值在$retval</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际项目里，Server端里为避免每次实例化当前类，可以写个父类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *Yar控制器类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YarAction</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 架构函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断扩展是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;yar&#x27;</span>))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;yar not support&#x27;</span>);</span><br><span class="line">        <span class="comment">//实例化Yar_Server</span></span><br><span class="line">        <span class="variable">$server</span>     =   <span class="keyword">new</span> <span class="title class_">Yar_Server</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="comment">// 启动server</span></span><br><span class="line">        <span class="variable">$server</span>-&gt;<span class="title function_ invoke__">handle</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="thinkphp使用yar"><a href="#thinkphp使用yar" class="headerlink" title="thinkphp使用yar"></a>thinkphp使用yar</h2><h3 id="thinkphp5-0版本"><a href="#thinkphp5-0版本" class="headerlink" title="thinkphp5.0版本"></a>thinkphp5.0版本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Server.php</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">controller</span>\<span class="title">Yar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">extends</span> <span class="title">Yar</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello yar&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$age</span>=<span class="literal">null</span></span>)</span>&#123;  <span class="comment">//传参数 要有默认值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello yar&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Client.php</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">controller</span>\<span class="title">Yar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">\Yar_Client</span>(<span class="string">&#x27;http://192.168.113.136:81/server&#x27;</span>);</span><br><span class="line">        <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">SetOpt</span>(YAR_OPT_PACKAGER,<span class="string">&#x27;php&#x27;</span>);  <span class="comment">//注意tp5只能用php  msgpack以及json报错</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">index</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="thinphp5-1-框架已经移除yar，需自己添加”-thinphp5-1-框架已经移除yar，需自己添加"><a href="#thinphp5-1-框架已经移除yar，需自己添加”-thinphp5-1-框架已经移除yar，需自己添加" class="headerlink" title="thinphp5.1 框架已经移除yar，需自己添加”)thinphp5.1 框架已经移除yar，需自己添加"></a>thinphp5.1 框架已经移除yar，需自己添加”)thinphp5.1 框架已经移除yar，需自己添加</h3><p>添加下面代码，然后在引入即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Yar</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//控制器初始化</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="string">&#x27;_initialize&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_initialize</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断扩展是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;yar&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&#x27;not support yar&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化Yar_Server</span></span><br><span class="line">        <span class="variable">$server</span> = <span class="keyword">new</span> <span class="title class_">\Yar_Server</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="comment">// 启动server</span></span><br><span class="line">        <span class="variable">$server</span>-&gt;<span class="title function_ invoke__">handle</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 魔术方法 有不存在的操作的时候执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $method 方法名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $args 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="php版本一定要-7-0以上的"><a href="#php版本一定要-7-0以上的" class="headerlink" title="php版本一定要 7.0以上的"></a>php版本一定要 7.0以上的</h3><h3 id="PHP-Fatal-error-Yar-Client-call-unsupported-packager-msgpack"><a href="#PHP-Fatal-error-Yar-Client-call-unsupported-packager-msgpack" class="headerlink" title="PHP Fatal error: Yar_Client::__call(): unsupported packager msgpack"></a>PHP Fatal error: <code>Yar_Client::__call()</code>: unsupported packager msgpack</h3><p>这个问题应该是编译 ar的时候没有加 <code>--enable-msgpack</code></p>
<h3 id="报错：-php-msgpack-unserialize-Extra-bytes-in-xxx"><a href="#报错：-php-msgpack-unserialize-Extra-bytes-in-xxx" class="headerlink" title="报错： (php_msgpack_unserialize) Extra bytes in xxx"></a>报错： (php_msgpack_unserialize) Extra bytes in xxx</h3><p>这个在tp5/tp6使用，就是tp5/tp6打包协议不能用msgpack和json只能选择php（这个问题暂时还没有解决，应该是tp5/tp6框架问题），只是一个warning，不影响使用。</p>
<h3 id="超时问题"><a href="#超时问题" class="headerlink" title="超时问题"></a>超时问题</h3><p>yar RPC请求默认超时设置为 5s,因此在客户端任务请求时，若果5s内没有得到响应，请求会持续5s</p>
<p>修改超时时间有两种方式 （时间单位：毫秒）<br>1.采用<code>ini_set()</code>方法实现对php.ini的动态修改<br><code>ini_set(&quot;yar.timeout&quot;,60000)</code>;<br>2.在yar注册服务方法种进行修改<br><code>Yar_Concurrent_Client::call(“http://localhost“, “some_method”, array(“parameters”), “callback”, NULL, array(YAR_OPT_TIMEOUT=&gt;1))</code>;<br>自己测试超时时间设置为低于200毫秒时，有一定机率出现请求失败。</p>
<h3 id="多次请求问题"><a href="#多次请求问题" class="headerlink" title="多次请求问题"></a>多次请求问题</h3><p>在用到多次并发请求时，后续请求的结果会包含上一次请求的数据<br>调用<code>Yar_Concurrent_Client::Reset()</code>清空第一次的请求结果，要求yar版本&gt;=1.2.4</p>
<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><h3 id="yar运行时的默认配置"><a href="#yar运行时的默认配置" class="headerlink" title="yar运行时的默认配置"></a>yar运行时的默认配置</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yar.timeout <span class="regexp">//</span>默认<span class="number">5000</span>（ms）</span><br><span class="line">yar.connect_timeout <span class="regexp">//</span>默认<span class="number">1000</span>（ms）</span><br><span class="line">yar.packager <span class="regexp">//</span>默认“php”，当使用--enable-msgpack构建然后默认为“msgpack”时，它应该是“php”，“json”，“msgpack”之一</span><br><span class="line">yar.debug <span class="regexp">//</span>默认关闭</span><br><span class="line">yar.expose_info <span class="regexp">//</span>默认开，是否输出GET请求的API信息</span><br><span class="line">yar.content_type <span class="regexp">//</span>默认“application / octet-stream”</span><br><span class="line">yar.allow_persistent <span class="regexp">//</span>默认关闭</span><br></pre></td></tr></table></figure>

<p>注意: yar.connect_time是一个以毫秒为单位的值，在1.2.1及之前以秒为单位进行测量。</p>
<h3 id="yar常量"><a href="#yar常量" class="headerlink" title="yar常量"></a>yar常量</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">YAR_VERSION</span></span><br><span class="line"><span class="attribute">YAR_OPT_PACKAGER</span></span><br><span class="line"><span class="attribute">YAR_OPT_PERSISTENT</span></span><br><span class="line"><span class="attribute">YAR_OPT_TIMEOUT</span></span><br><span class="line"><span class="attribute">YAR_OPT_CONNECT_TIMEOUT</span></span><br><span class="line"><span class="attribute">YAR_OPT_HEADER</span> //从<span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>开始</span><br></pre></td></tr></table></figure>

<h3 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Yar_Server <span class="comment">//The Yar_Server class</span></span><br><span class="line"><span class="title class_">Yar_Server</span>::<span class="title function_ invoke__">__construct</span>() <span class="comment">//创建一个HTTP RPC Server</span></span><br><span class="line"><span class="title class_">Yar_Server</span>::<span class="title function_ invoke__">handle</span>() <span class="comment">//启动HTTP RPC Server</span></span><br><span class="line"></span><br><span class="line">Yar_Client  <span class="comment">//The Yar_Client class</span></span><br><span class="line"><span class="title class_">Yar_Client</span>::<span class="title function_ invoke__">__call</span>()  <span class="comment">//调用远程服务</span></span><br><span class="line"><span class="title class_">Yar_Client</span>::<span class="title function_ invoke__">__construct</span>()  <span class="comment">//创建一个客户端实例</span></span><br><span class="line"><span class="title class_">Yar_Client</span>::<span class="title function_ invoke__">setOpt</span>() <span class="comment">//设置调用的配置</span></span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line"><span class="comment">//Set timeout to 1s</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">SetOpt</span>(YAR_OPT_CONNECT_TIMEOUT, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Set packager to JSON</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">SetOpt</span>(YAR_OPT_PACKAGER, <span class="string">&quot;json&quot;</span>);</span><br><span class="line"></span><br><span class="line">Yar_Concurrent_Client  <span class="comment">//The Yar_Concurrent_Client class</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>() <span class="comment">//注册一个并行的服务调用</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">loop</span>() <span class="comment">//发送所有注册的并行调用</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">reset</span>() <span class="comment">//Clean all registered calls</span></span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;some_method&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// if the callback is not specificed, callback in loop will be used</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;some_method&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//this server accept json packager</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;some_method&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>, <span class="literal">NULL</span>, <span class="keyword">array</span>(YAR_OPT_PACKAGER =&gt; <span class="string">&quot;json&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//custom timeout</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">call</span>(<span class="string">&quot;http://host/api/&quot;</span>, <span class="string">&quot;some_method&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;parameters&quot;</span>), <span class="string">&quot;callback&quot;</span>, <span class="literal">NULL</span>, <span class="keyword">array</span>(YAR_OPT_TIMEOUT=&gt;<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//send the requests, the error_callback is optional</span></span><br><span class="line"><span class="title class_">Yar_Concurrent_Client</span>::<span class="title function_ invoke__">loop</span>(<span class="string">&quot;callback&quot;</span>, <span class="string">&quot;error_callback&quot;</span>);</span><br><span class="line"></span><br><span class="line">Yar_Server_Exception <span class="comment">//The Yar_Server_Exception class</span></span><br><span class="line"><span class="title class_">Yar_Server_Exception</span>::<span class="title function_ invoke__">getType</span>() <span class="comment">//获取异常的原始类型</span></span><br><span class="line"></span><br><span class="line">Yar_Client_Exception  <span class="comment">//The Yar_Client_Exception class</span></span><br><span class="line"><span class="title class_">Yar_Client_Exception</span>::<span class="title function_ invoke__">getType</span>() <span class="comment">//The getType purpose</span></span><br></pre></td></tr></table></figure>

<p>具体使用方法可以参考这篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/yizhou35/article/details/30283923">点击查看</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://moqiang02.github.io/2021/11/04/Yar%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/" data-id="cla0v66290164g0v1d6rggla1" data-title="Yar的安装及使用" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/11/05/Go-Context/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          Go Context
        
      </div>
    </a>
  
  
    <a href="/2021/10/25/go%E5%92%8Cphp%E4%B8%AD%E7%9A%84gRpc%E5%AE%9E%E6%88%98/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">go和php中的gRpc实战</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">255</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/apache/">apache</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/flutter/">flutter</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github%E5%8D%9A%E5%AE%A2/">github博客</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html-css/">html+css</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iis/">iis</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">78</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">115</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">72</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">41</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs/">nodejs</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">185</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E5%AE%83/">其它</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">51</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/">开源项目</a><span class="category-list-count">73</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/">生活随笔</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/">量化交易</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AndroidStudio/" style="font-size: 13.33px;">AndroidStudio</a> <a href="/tags/AndroidUI/" style="font-size: 20px;">AndroidUI</a> <a href="/tags/Android%E4%BA%8B%E4%BB%B6%E6%8B%A6%E6%88%AA/" style="font-size: 11.11px;">Android事件拦截</a> <a href="/tags/Android%E5%BC%80%E6%BA%90/" style="font-size: 17.22px;">Android开源</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/CURL/" style="font-size: 12.78px;">CURL</a> <a href="/tags/DEDE/" style="font-size: 18.33px;">DEDE</a> <a href="/tags/Docker/" style="font-size: 14.44px;">Docker</a> <a href="/tags/Flask/" style="font-size: 10.56px;">Flask</a> <a href="/tags/JavaSE/" style="font-size: 18.89px;">JavaSE</a> <a href="/tags/Laravel/" style="font-size: 17.22px;">Laravel</a> <a href="/tags/Maven/" style="font-size: 11.11px;">Maven</a> <a href="/tags/MybatisPlus/" style="font-size: 11.11px;">MybatisPlus</a> <a href="/tags/SVN/" style="font-size: 10px;">SVN</a> <a href="/tags/SpringBoot/" style="font-size: 19.44px;">SpringBoot</a> <a href="/tags/Thinkphp/" style="font-size: 10px;">Thinkphp</a> <a href="/tags/UEditor/" style="font-size: 11.67px;">UEditor</a> <a href="/tags/VMware/" style="font-size: 12.22px;">VMware</a> <a href="/tags/Vue/" style="font-size: 17.78px;">Vue</a> <a href="/tags/WebSocket/" style="font-size: 12.78px;">WebSocket</a> <a href="/tags/ecshop/" style="font-size: 14.44px;">ecshop</a> <a href="/tags/scrapy/" style="font-size: 13.89px;">scrapy</a> <a href="/tags/smarty/" style="font-size: 12.22px;">smarty</a> <a href="/tags/socket/" style="font-size: 14.44px;">socket</a> <a href="/tags/sphinx/" style="font-size: 11.67px;">sphinx</a> <a href="/tags/vagrant/" style="font-size: 12.22px;">vagrant</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 11.11px;">微服务</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" style="font-size: 15px;">数据传输</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 11.67px;">正则</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 15.56px;">消息队列</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 16.11px;">爬虫</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 16.67px;">集群</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/02/24/Java%E6%96%B9%E6%B3%95%E4%BC%A0%E5%8F%82%E5%88%B0%E5%BA%95%E4%BC%A0%E6%89%80%E9%9C%80%E5%8F%82%E6%95%B0%E5%A5%BD%E8%BF%98%E6%98%AF%E4%BC%A0%E5%AE%9E%E4%BD%93%E5%A5%BD%EF%BC%9F/">Java方法传参到底传所需参数好还是传实体好？</a>
          </li>
        
          <li>
            <a href="/2023/02/09/Java8%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E6%96%B0%E6%96%B9%E6%B3%95/">Java8集合框架中的新方法</a>
          </li>
        
          <li>
            <a href="/2023/01/22/APM%E8%B0%83%E7%A0%94/">APM调研</a>
          </li>
        
          <li>
            <a href="/2023/01/22/linux-%E7%AE%80%E5%8D%95%E7%9A%84mysql%E5%A4%87%E4%BB%BD%E5%92%8C%E5%AF%BC%E5%85%A5%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E7%9A%84%E5%A4%87%E4%BB%BD%E5%92%8C%E5%AF%BC%E5%85%A5/">linux 简单的mysql备份和导入，以及文件的备份和导入</a>
          </li>
        
          <li>
            <a href="/2023/01/15/ThreadLocal%E8%AF%A6%E8%A7%A3/">ThreadLocal详解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 moqiang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>

<!-- rex -->

<script src="/js/toc.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>