<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>SpringBoot使用@Async实现异步任务 | 自强不息</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="使用@Async实现异步调用什么是“异步调用”？“异步调用”对应的是“同步调用”，同步调用指程序按照定义顺序依次执行，每一行程序都必须等待上一行程序执行完成之后才能执行；异步调用指程序在顺序执行时，不等待异步调用的语句返回结果就执行后面的程序。">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot使用@Async实现异步任务">
<meta property="og:url" content="http://moqiang02.github.io/2022/10/05/SpringBoot%E4%BD%BF%E7%94%A8-Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/index.html">
<meta property="og:site_name" content="自强不息">
<meta property="og:description" content="使用@Async实现异步调用什么是“异步调用”？“异步调用”对应的是“同步调用”，同步调用指程序按照定义顺序依次执行，每一行程序都必须等待上一行程序执行完成之后才能执行；异步调用指程序在顺序执行时，不等待异步调用的语句返回结果就执行后面的程序。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://moqiang02.github.io/images/SpringBoot%E4%BD%BF%E7%94%A8Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/2-1.png">
<meta property="article:published_time" content="2022-10-05T14:55:50.000Z">
<meta property="article:modified_time" content="2025-06-11T08:16:29.511Z">
<meta property="article:author" content="moqiang">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://moqiang02.github.io/images/SpringBoot%E4%BD%BF%E7%94%A8Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/2-1.png">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">自强不息</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://moqiang02.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-SpringBoot使用-Async实现异步任务" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/05/SpringBoot%E4%BD%BF%E7%94%A8-Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/" class="article-date">
  <time class="dt-published" datetime="2022-10-05T14:55:50.000Z" itemprop="datePublished">2022-10-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      SpringBoot使用@Async实现异步任务
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      

          <!-- rex -->
          
            <!-- 文章目录开始 -->
            
              <div id="toc" class="toc-article">
              <strong class="toc-title" style="cursor:pointer">目录</strong>
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">使用@Async实现异步调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">同步调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">异步调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83"><span class="toc-number">1.3.</span> <span class="toc-text">异步回调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Async%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">2.</span> <span class="toc-text">配置@Async异步任务的线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">2.1.</span> <span class="toc-text">配置默认线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%89%8B%E8%AF%95%E4%B8%80%E8%AF%95"><span class="toc-number">2.2.</span> <span class="toc-text">动手试一试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">2.3.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%9A%94%E7%A6%BB-Async%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">3.</span> <span class="toc-text">如何隔离@Async异步任务的线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E9%9A%94%E7%A6%BB%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%9A%94%E7%A6%BB"><span class="toc-number">3.1.</span> <span class="toc-text">什么是线程池的隔离，为什么要隔离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">3.2.</span> <span class="toc-text">不同异步任务配置不同线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">3.3.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">4.</span> <span class="toc-text">配置线程池的拒绝策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E9%87%8D%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">场景重现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.</span> <span class="toc-text">配置拒绝策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">4.3.</span> <span class="toc-text">代码示例</span></a></li></ol></li></ol>
              </div>
            
            <!-- 文章目录结束 -->	  
          

        <h1 id="使用-Async实现异步调用"><a href="#使用-Async实现异步调用" class="headerlink" title="使用@Async实现异步调用"></a>使用@Async实现异步调用</h1><p>什么是“异步调用”？“异步调用”对应的是“同步调用”，同步调用指程序按照定义顺序依次执行，每一行程序都必须等待上一行程序执行完成之后才能执行；异步调用指程序在顺序执行时，不等待异步调用的语句返回结果就执行后面的程序。<span id="more"></span></p>
<h2 id="同步调用"><a href="#同步调用" class="headerlink" title="同步调用"></a>同步调用</h2><p>下面通过一个简单示例来直观的理解什么是同步调用：</p>
<p>定义Task类，创建三个处理函数分别模拟三个执行任务的操作，操作消耗时间随机取（10秒内）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncTasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskOne</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务一&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务一，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskTwo</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务二&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务二，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskThree</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务三&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务三，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在单元测试用例中，注入Task对象，并在测试用例中执行<code>doTaskOne</code>、<code>doTaskTwo</code>、<code>doTaskThree</code>三个函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chapter75ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTasks asyncTasks;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        asyncTasks.doTaskOne();</span><br><span class="line">        asyncTasks.doTaskTwo();</span><br><span class="line">        asyncTasks.doTaskThree();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行单元测试，可以看到类似如下输出：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">12.922</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务一</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">17.788</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务一，耗时：<span class="number">4865</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">17.788</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务二</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">24.851</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务二，耗时：<span class="number">7063</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">24.851</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务三</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">19</span>:<span class="number">26.928</span>  INFO <span class="number">92539</span> --- <span class="selector-attr">[           main]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务三，耗时：<span class="number">2076</span>毫秒</span><br></pre></td></tr></table></figure>
<p>任务一、任务二、任务三顺序的执行完了，换言之doTaskOne、doTaskTwo、doTaskThree三个函数顺序的执行完成。</p>
<h2 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h2><p>上述的同步调用虽然顺利的执行完了三个任务，但是可以看到执行时间比较长，若这三个任务本身之间不存在依赖关系，可以并发执行的话，同步调用在执行效率方面就比较差，可以考虑通过异步调用的方式来并发执行。</p>
<p>在Spring Boot中，我们只需要通过使用<code>@Async</code>注解就能简单的将原来的同步函数变为异步函数，Task类改在为如下模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncTasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskOne</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务一&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务一，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskTwo</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务二&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务二，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTaskThree</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始做任务三&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务三，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了让@Async注解能够生效，还需要在Spring Boot的主程序中配置@EnableAsync，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chapter75Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Chapter75Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时可以反复执行单元测试，您可能会遇到各种不同的结果，比如：</p>
<ul>
<li>  没有任何任务相关的输出</li>
<li>  有部分任务相关的输出</li>
<li>  乱序的任务相关的输出</li>
</ul>
<p>原因是目前<code>doTaskOne</code>、<code>doTaskTwo</code>、<code>doTaskThree</code>三个函数的时候已经是异步执行了。主程序在异步调用之后，主程序并不会理会这三个函数是否执行完成了，由于没有其他需要执行的内容，所以程序就自动结束了，导致了不完整或是没有输出任务相关内容的情况。</p>
<p>注：<code>@Async</code>所修饰的函数不要定义为static类型，这样异步调用不会生效</p>
<h2 id="异步回调"><a href="#异步回调" class="headerlink" title="异步回调"></a>异步回调</h2><p>为了让<code>doTaskOne</code>、<code>doTaskTwo</code>、<code>doTaskThree</code>能正常结束，假设我们需要统计一下三个任务并发执行共耗时多少，这就需要等到上述三个函数都完成调动之后记录时间，并计算结果。</p>
<p>那么我们如何判断上述三个异步调用是否已经执行完成呢？我们需要使用<code>CompletableFuture&lt;T&gt;</code>来返回异步调用的结果，就像如下方式改造<code>doTaskOne</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">doTaskOne</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    log.info(<span class="string">&quot;开始做任务一&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.info(<span class="string">&quot;完成任务一，耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;任务一完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照如上方式改造一下其他两个异步函数之后，下面我们改造一下测试用例，让测试在等待完成三个异步调用之后来做一些其他事情。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne();</span><br><span class="line">    CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskTwo();</span><br><span class="line">    CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskThree();</span><br><span class="line"></span><br><span class="line">    CompletableFuture.allOf(task1, task2, task3).join();</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;任务全部完成，总耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看看我们做了哪些改变：</p>
<ul>
<li>  在测试用例一开始记录开始时间</li>
<li>  在调用三个异步函数的时候，返回<code>CompletableFuture&lt;String&gt;</code>类型的结果对象</li>
<li>  通过<code>CompletableFuture.allOf(task1, task2, task3).join()</code>实现三个异步任务都结束之前的阻塞效果</li>
<li>  三个任务都完成之后，根据结束时间 - 开始时间，计算出三个任务并发执行的总耗时。</li>
</ul>
<p>执行一下上述的单元测试，可以看到如下结果：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">38.842</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-3]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务三</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">38.842</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务二</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">38.842</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务一</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">45.155</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务二，耗时：<span class="number">6312</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">47.308</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-3]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务三，耗时：<span class="number">8465</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">47.403</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter75</span><span class="selector-class">.AsyncTasks</span>       : 完成任务一，耗时：<span class="number">8560</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">23</span>:<span class="number">33</span>:<span class="number">47.404</span>  INFO <span class="number">95891</span> --- <span class="selector-attr">[           main]</span> c<span class="selector-class">.d</span><span class="selector-class">.chapter75</span><span class="selector-class">.Chapter75ApplicationTests</span>  : 任务全部完成，总耗时：<span class="number">8590</span>毫秒</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，通过异步调用，让任务一、二、三并发执行，有效的减少了程序的总运行时间。</p>
<p>本系列教程<a target="_blank" rel="noopener" href="http://blog.didispace.com/spring-boot-learning-2x/">《Spring Boot 2.x基础教程》点击直达！</a>，欢迎收藏与转发！如果学习过程中如遇困难？可以加入我们的 <a target="_blank" rel="noopener" href="https://blog.didispace.com/join-group-spring/index.html">Spring技术交流群</a>，参与交流与讨论，更好的学习与进步！</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>本文的完整工程可以查看下面仓库中<code>2.x</code>目录下的<code>chapter7-5</code>工程：</p>
<ul>
<li>  Github：<a target="_blank" rel="noopener" href="https://github.com/dyc87112/SpringBoot-Learning/tree/master/2.x">https://github.com/dyc87112/SpringBoot-Learning/</a></li>
<li>  Gitee：<a target="_blank" rel="noopener" href="https://gitee.com/didispace/SpringBoot-Learning/tree/master/2.x">https://gitee.com/didispace/SpringBoot-Learning/</a></li>
</ul>
<h1 id="配置-Async异步任务的线程池"><a href="#配置-Async异步任务的线程池" class="headerlink" title="配置@Async异步任务的线程池"></a>配置@Async异步任务的线程池</h1><p>上一篇我们介绍了<a target="_blank" rel="noopener" href="https://blog.didispace.com/spring-boot-learning-2-7-5/">如何使用<code>@Async</code>注解来创建异步任务</a>，我可以用这种方法来实现一些并发操作，以加速任务的执行效率。但是，如果只是如前文那样直接简单的创建来使用，可能还是会碰到一些问题。存在有什么问题呢？先来思考下，下面的这个接口，通过异步任务加速执行的实现，是否存在问题或风险呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTasks asyncTasks;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 将可以并行的处理逻辑，拆分成三个异步任务同时执行</span></span><br><span class="line">        CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne();</span><br><span class="line">        CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskTwo();</span><br><span class="line">        CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskThree();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.allOf(task1, task2, task3).join();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然，从单次接口调用来说，是没有问题的。但当接口被客户端频繁调用的时候，异步任务的数量就会大量增长：3 x n（n为请求数量），如果任务处理不够快，就很可能会出现内存溢出的情况。那么为什么会内存溢出呢？根本原因是由于Spring Boot默认用于异步任务的线程池是这样配置的：</p>
<p><img src="/images/SpringBoot%E4%BD%BF%E7%94%A8Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/2-1.png"></p>
<p>图中我标出的两个重要参数是需要关注的：</p>
<ul>
<li>  <code>queueCapacity</code>：缓冲队列的容量，默认为INT的最大值（2的31次方-1）。</li>
<li>  <code>maxSize</code>：允许的最大线程数，默认为INT的最大值（2的31次方-1）。</li>
</ul>
<p>所以，默认情况下，一般任务队列就可能把内存给堆满了。所以，我们真正使用的时候，还需要对异步任务的执行线程池做一些基础配置，以防止出现内存溢出导致服务不可用的问题。</p>
<h2 id="配置默认线程池"><a href="#配置默认线程池" class="headerlink" title="配置默认线程池"></a>配置默认线程池</h2><p>默认线程池的配置很简单，只需要在配置文件中完成即可，主要有以下这些参数：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.task.execution.pool.<span class="attribute">core-size</span>=2 # 线程池创建时的初始化线程数，默认为8</span><br><span class="line">spring.task.execution.pool.<span class="attribute">max-size</span>=5   # 线程池的最大线程数，默认为int最大值</span><br><span class="line">spring.task.execution.pool.<span class="attribute">queue-capacity</span>=10  # 用来缓冲执行任务的队列，默认为int最大值</span><br><span class="line">spring.task.execution.pool.<span class="attribute">keep-alive</span>=60s  # 线程终止前允许保持空闲的时间</span><br><span class="line">spring.task.execution.pool.<span class="attribute">allow-core-thread-timeout</span>=<span class="literal">true</span> # 线程终止前允许保持空闲的时间</span><br><span class="line">spring.task.execution.shutdown.<span class="attribute">await-termination</span>=<span class="literal">false</span> # 是否等待剩余任务完成后才关闭应用</span><br><span class="line">spring.task.execution.shutdown.await-termination-period=  # 等待剩余任务完成的最大时间</span><br><span class="line">spring.task.execution.<span class="attribute">thread-name-prefix</span>=task-  # 线程名的前缀，设置好了之后可以方便我们在日志中查看处理任务所在的线程池</span><br></pre></td></tr></table></figure>


<h2 id="动手试一试"><a href="#动手试一试" class="headerlink" title="动手试一试"></a>动手试一试</h2><p>我们直接基于之前<code>chapter7-5</code>的结果来进行如下操作。</p>
<p>首先，在没有进行线程池配置之前，可以先执行一下单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne();</span><br><span class="line">    CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskTwo();</span><br><span class="line">    CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskThree();</span><br><span class="line"></span><br><span class="line">    CompletableFuture.allOf(task1, task2, task3).join();</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;任务全部完成，总耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于默认线程池的核心线程数是8，所以3个任务会同时开始执行，日志输出是这样的：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">14.819</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务二</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">14.819</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-3]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务三</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">14.819</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务一</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">15.491</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务二，耗时：<span class="number">672</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">19.496</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-3]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务三，耗时：<span class="number">4677</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">20.443</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务一，耗时：<span class="number">5624</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">30</span>:<span class="number">20.443</span>  INFO <span class="number">77614</span> --- <span class="selector-attr">[           main]</span> c<span class="selector-class">.d</span><span class="selector-class">.chapter76</span><span class="selector-class">.Chapter76ApplicationTests</span>  : 任务全部完成，总耗时：<span class="number">5653</span>毫秒</span><br></pre></td></tr></table></figure>
<p>接着，可以尝试在配置文件中增加如下的线程池配置</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span><span class="selector-class">.pool</span>.core-size=<span class="number">2</span></span><br><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span><span class="selector-class">.pool</span>.max-size=<span class="number">5</span></span><br><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span><span class="selector-class">.pool</span>.queue-capacity=<span class="number">10</span></span><br><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span><span class="selector-class">.pool</span>.keep-alive=<span class="number">60s</span></span><br><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span><span class="selector-class">.pool</span>.allow-core-thread-timeout=true</span><br><span class="line">spring<span class="selector-class">.task</span><span class="selector-class">.execution</span>.thread-name-prefix=task-</span><br></pre></td></tr></table></figure>
<p>日志输出的顺序会变成如下的顺序：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.013</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务一</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.013</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务二</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">52.452</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务一，耗时：<span class="number">2439</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">52.452</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 开始做任务三</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">55.880</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务二，耗时：<span class="number">5867</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">00.346</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[         task-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter76</span><span class="selector-class">.AsyncTasks</span>       : 完成任务三，耗时：<span class="number">7894</span>毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">00.347</span>  INFO <span class="number">77985</span> --- <span class="selector-attr">[           main]</span> c<span class="selector-class">.d</span><span class="selector-class">.chapter76</span><span class="selector-class">.Chapter76ApplicationTests</span>  : 任务全部完成，总耗时：<span class="number">10363</span>毫秒</span><br></pre></td></tr></table></figure>
<ul>
<li>  任务一和任务二会马上占用核心线程，任务三进入队列等待</li>
<li>  任务一完成，释放出一个核心线程，任务三从队列中移出，并占用核心线程开始处理</li>
</ul>
<blockquote>
<p>注意：这里可能有的小伙伴会问，最大线程不是5么，为什么任务三是进缓冲队列，不是创建新线程来处理吗？这里要理解缓冲队列与最大线程间的关系：只有在缓冲队列满了之后才会申请超过核心线程数的线程来进行处理。所以，这里只有缓冲队列中10个任务满了，再来第11个任务的时候，才会在线程池中创建第三个线程来处理。这个这里就不具体写列子了，读者可以自己调整下参数，或者调整下单元测试来验证这个逻辑。</p>
</blockquote>
<p>好了，今天的学习就到这里！如果您学习过程中如遇困难？可以加入我们超高质量的<a target="_blank" rel="noopener" href="https://blog.didispace.com/join-group-spring/index.html">Spring技术交流群</a>，参与交流与讨论，更好的学习与进步！更多 <a target="_blank" rel="noopener" href="http://blog.didispace.com/spring-boot-learning-2x/">Spring Boot教程可以点击直达！</a>，欢迎收藏与转发支持！</p>
<h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><p>本文的完整工程可以查看下面仓库中<code>2.x</code>目录下的<code>chapter7-6</code>工程：</p>
<ul>
<li>  Github：<a target="_blank" rel="noopener" href="https://github.com/dyc87112/SpringBoot-Learning/tree/master/2.x">https://github.com/dyc87112/SpringBoot-Learning/</a></li>
<li>  Gitee：<a target="_blank" rel="noopener" href="https://gitee.com/didispace/SpringBoot-Learning/tree/master/2.x">https://gitee.com/didispace/SpringBoot-Learning/</a></li>
</ul>
<h1 id="如何隔离-Async异步任务的线程池"><a href="#如何隔离-Async异步任务的线程池" class="headerlink" title="如何隔离@Async异步任务的线程池"></a>如何隔离@Async异步任务的线程池</h1><p>通过<a target="_blank" rel="noopener" href="https://blog.didispace.com/spring-boot-learning-2-7-6/">上一篇：配置@Async异步任务的线程池</a>的介绍，你应该已经了解到异步任务的执行背后有一个线程池来管理执行任务。为了控制异步任务的并发不影响到应用的正常运作，我们必须要对线程池做好相应的配置，防止资源的过渡使用。除了默认线程池的配置之外，还有一类场景，也是很常见的，那就是多任务情况下的线程池隔离。</p>
<h2 id="什么是线程池的隔离，为什么要隔离"><a href="#什么是线程池的隔离，为什么要隔离" class="headerlink" title="什么是线程池的隔离，为什么要隔离"></a>什么是线程池的隔离，为什么要隔离</h2><p>可能有的小伙伴还不太了解<strong>什么是线程池的隔离，为什么要隔离</strong>？所以，我们先来看看下面的场景案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTasks asyncTasks;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api-1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">taskOne</span><span class="params">()</span> &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskOne(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskOne(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.allOf(task1, task2, task3).join();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api-2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">taskTwo</span><span class="params">()</span> &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskTwo(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskTwo(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskTwo(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.allOf(task1, task2, task3).join();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中，有两个API接口，这两个接口的具体执行逻辑中都会把执行过程拆分为三个异步任务来实现。</p>
<p>好了，思考一分钟，想一下。如果这样实现，会有什么问题吗？</p>
<p>上面这段代码，在API请求并发不高，同时如果每个任务的处理速度也够快的时候，是没有问题的。但如果并发上来或其中某几个处理过程扯后腿了的时候。这两个提供不相干服务的接口可能会互相影响。比如：假设当前线程池配置的最大线程数有2个，这个时候/api-1接口中task1和task2处理速度很慢，阻塞了；那么此时，当用户调用api-2接口的时候，这个服务也会阻塞！</p>
<p>造成这种现场的原因是：默认情况下，所有用<code>@Async</code>创建的异步任务都是共用的一个线程池，所以当有一些异步任务碰到性能问题的时候，是会直接影响其他异步任务的。</p>
<p>为了解决这个问题，我们就需要对异步任务做一定的线程池隔离，让不同的异步任务互不影响。</p>
<h2 id="不同异步任务配置不同线程池"><a href="#不同异步任务配置不同线程池" class="headerlink" title="不同异步任务配置不同线程池"></a>不同异步任务配置不同线程池</h2><p>下面，我们就来实际操作一下！</p>
<p><strong>第一步</strong>：初始化多个线程池，比如下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskPoolConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">2</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">2</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">10</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;executor-1-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        在一些场景下，若需要在关闭线程池时等待当前调度任务完成后才开始关闭，可以通过简单的配置，进行优雅的停机策略配置。</span></span><br><span class="line"><span class="comment">        关键就是通过setWaitForTasksToCompleteOnShutdown(true)和setAwaitTerminationSeconds方法。</span></span><br><span class="line"><span class="comment">        - setWaitForTasksToCompleteOnShutdown:表明等待所有线程执行完，默认为false。</span></span><br><span class="line"><span class="comment">        - setAwaitTerminationSeconds:等待的时间，因为不能无限的等待下去。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        executor.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        executor.setAwaitTerminationSeconds(<span class="number">1800</span>);</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">2</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">2</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">10</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;executor-2-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：这里特地用<code>executor.setThreadNamePrefix</code>设置了线程名的前缀，这样可以方便观察后面具体执行的顺序。<br>通过实际测试所得结论：我在for循环里调用100次异步任务，异步任务里sleep-10秒钟，然后打印一句话。程序启动后，这句话最多打印QueueCapacity+setMaxPoolSize+1次，比如taskExecutor1线程池最多打印15次，然后程序就阻塞了。之后每消费完一个任务，才会再往队列里添加一个任务，直到100个任务全部完成。</p>
</blockquote>
<p><strong>第二步</strong>：创建异步任务，并指定要使用的线程池名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncTasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;taskExecutor1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">doTaskOne</span><span class="params">(String taskNo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始任务：&#123;&#125;&quot;</span>, taskNo);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务：&#123;&#125;，耗时：&#123;&#125; 毫秒&quot;</span>, taskNo, end - start);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;任务完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;taskExecutor2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">doTaskTwo</span><span class="params">(String taskNo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始任务：&#123;&#125;&quot;</span>, taskNo);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务：&#123;&#125;，耗时：&#123;&#125; 毫秒&quot;</span>, taskNo, end - start);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;任务完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>@Async</code>注解中定义的<code>taskExecutor1</code>和<code>taskExecutor2</code>就是线程池的名字。由于在第一步中，我们没有具体写两个线程池Bean的名称，所以默认会使用方法名，也就是<code>taskExecutor1</code>和<code>taskExecutor2</code>。</p>
<p><strong>第三步</strong>：写个单元测试来验证下，比如下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chapter77ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTasks asyncTasks;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程池1</span></span><br><span class="line">        CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskOne(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskOne(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程池2</span></span><br><span class="line">        CompletableFuture&lt;String&gt; task4 = asyncTasks.doTaskTwo(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task5 = asyncTasks.doTaskTwo(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task6 = asyncTasks.doTaskTwo(<span class="string">&quot;6&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一起执行</span></span><br><span class="line">        CompletableFuture.allOf(task1, task2, task3, task4, task5, task6).join();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;任务全部完成，总耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的单元测试中，一共启动了6个异步任务，前三个用的是线程池1，后三个用的是线程池2。</p>
<p>先不执行，根据设置的核心线程2和最大线程数2，来分析一下，大概会是怎么样的执行情况？</p>
<ol>
<li> 线程池1的三个任务，task1和task2会先获得执行线程，然后task3因为没有可分配线程进入缓冲队列</li>
<li> 线程池2的三个任务，task4和task5会先获得执行线程，然后task6因为没有可分配线程进入缓冲队列</li>
<li> 任务task3会在task1或task2完成之后，开始执行</li>
<li> 任务task6会在task4或task5完成之后，开始执行</li>
</ol>
<p>分析好之后，执行下单元测试，看看是否是这样的：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">11.369</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">11.369</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">5</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">11.369</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">4</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">11.369</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">2</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">15.905</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">4</span>，耗时：<span class="number">4532</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">15.905</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">6</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">18.263</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">2</span>，耗时：<span class="number">6890</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">18.263</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">3</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">18.896</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">5</span>，耗时：<span class="number">7523</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">19.842</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">3</span>，耗时：<span class="number">1579</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">20.551</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-1-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">1</span>，耗时：<span class="number">9178</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">24.117</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[   executor-2-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter77</span><span class="selector-class">.AsyncTasks</span>       : 完成任务：<span class="number">6</span>，耗时：<span class="number">8212</span> 毫秒</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">23</span>:<span class="number">45</span>:<span class="number">24.117</span>  INFO <span class="number">61670</span> --- <span class="selector-attr">[           main]</span> c<span class="selector-class">.d</span><span class="selector-class">.chapter77</span><span class="selector-class">.Chapter77ApplicationTests</span>  : 任务全部完成，总耗时：<span class="number">12762</span>毫秒</span><br></pre></td></tr></table></figure>
<p>好了，今天的学习就到这里！如果您学习过程中如遇困难？可以加入我们超高质量的<a target="_blank" rel="noopener" href="https://blog.didispace.com/join-group-spring/index.html">Spring技术交流群</a>，参与交流与讨论，更好的学习与进步！更多<a target="_blank" rel="noopener" href="http://blog.didispace.com/spring-boot-learning-2x/">Spring Boot教程可以点击直达！</a>，欢迎收藏与转发支持！</p>
<h2 id="代码示例-2"><a href="#代码示例-2" class="headerlink" title="代码示例"></a>代码示例</h2><p>本文的完整工程可以查看下面仓库中<code>2.x</code>目录下的<code>chapter7-7</code>工程：</p>
<ul>
<li>  Github：<a target="_blank" rel="noopener" href="https://github.com/dyc87112/SpringBoot-Learning/tree/master/2.x">https://github.com/dyc87112/SpringBoot-Learning/</a></li>
<li>  Gitee：<a target="_blank" rel="noopener" href="https://gitee.com/didispace/SpringBoot-Learning/tree/master/2.x">https://gitee.com/didispace/SpringBoot-Learning/</a></li>
</ul>
<h1 id="配置线程池的拒绝策略"><a href="#配置线程池的拒绝策略" class="headerlink" title="配置线程池的拒绝策略"></a>配置线程池的拒绝策略</h1><p>通过之前三篇关于Spring Boot异步任务实现的博文，我们分别学会了<a target="_blank" rel="noopener" href="https://blog.didispace.com/spring-boot-learning-2-7-5">用@Async创建异步任务</a>、<a target="_blank" rel="noopener" href="https://blog.didispace.com/spring-boot-learning-2-7-6">为异步任务配置线程池</a>、<a target="_blank" rel="noopener" href="https://blog.didispace.com/spring-boot-learning-2-7-7">使用多个线程池隔离不同的异步任务</a>。今天这篇，我们继续对上面的知识进行完善和优化！</p>
<p>如果你已经看过上面几篇内容并已经掌握之后，一起来思考下面这个问题：</p>
<blockquote>
<p>假设，线程池配置为核心线程数2、最大线程数2、缓冲队列长度2。此时，有5个异步任务同时开始，会发生什么？</p>
</blockquote>
<h2 id="场景重现"><a href="#场景重现" class="headerlink" title="场景重现"></a>场景重现</h2><p>我们先来把上面的假设用代码实现一下：</p>
<p><strong>第一步</strong>：创建Spring Boot应用，根据上面的假设写好线程池配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chapter78Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Chapter78Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnableAsync</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TaskPoolConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Executor <span class="title function_">taskExecutor1</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">            executor.setCorePoolSize(<span class="number">2</span>);</span><br><span class="line">            executor.setMaxPoolSize(<span class="number">2</span>);</span><br><span class="line">            executor.setQueueCapacity(<span class="number">2</span>);</span><br><span class="line">            executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">            executor.setThreadNamePrefix(<span class="string">&quot;executor-1-&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> executor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第二步</strong>：用<code>@Async</code>注解实现一个部分任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncTasks</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;taskExecutor1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">doTaskOne</span><span class="params">(String taskNo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始任务：&#123;&#125;&quot;</span>, taskNo);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;完成任务：&#123;&#125;，耗时：&#123;&#125; 毫秒&quot;</span>, taskNo, end - start);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;任务完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第三步</strong>：编写测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chapter78ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTasks asyncTasks;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 线程池配置：core-2,max-2,queue=2，同时有5个任务，出现下面异常：</span></span><br><span class="line">        <span class="comment">// org.springframework.core.task.TaskRejectedException: Executor [java.util.concurrent.ThreadPoolExecutor@59901c4d[Running, pool size = 2,</span></span><br><span class="line">        <span class="comment">// active threads = 0, queued tasks = 2, completed tasks = 4]] did not accept task: java.util.concurrent.CompletableFuture$AsyncSupply@408e96d9</span></span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程池1</span></span><br><span class="line">        CompletableFuture&lt;String&gt; task1 = asyncTasks.doTaskOne(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task2 = asyncTasks.doTaskOne(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task3 = asyncTasks.doTaskOne(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task4 = asyncTasks.doTaskOne(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        CompletableFuture&lt;String&gt; task5 = asyncTasks.doTaskOne(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一起执行</span></span><br><span class="line">        CompletableFuture.allOf(task1, task2, task3, task4, task5).join();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;任务全部完成，总耗时：&quot;</span> + (end - start) + <span class="string">&quot;毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行一下，可以类似下面这样的日志信息：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">08.159</span>  INFO <span class="number">21119</span> --- <span class="selector-attr">[   executor-1-2]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter78</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">2</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">08.159</span>  INFO <span class="number">21119</span> --- <span class="selector-attr">[   executor-1-1]</span> com<span class="selector-class">.didispace</span><span class="selector-class">.chapter78</span><span class="selector-class">.AsyncTasks</span>       : 开始任务：<span class="number">1</span></span><br><span class="line"></span><br><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.core</span><span class="selector-class">.task</span><span class="selector-class">.TaskRejectedException</span>: Executor <span class="selector-attr">[java.util.concurrent.ThreadPoolExecutor@3e1a3801[Running, pool size = 2, active threads = 2, queued tasks = 2, completed tasks = 0]</span>] did not accept task: java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.CompletableFuture<span class="variable">$AsyncSupply</span>@<span class="number">64968732</span></span><br><span class="line"></span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.scheduling</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolTaskExecutor</span><span class="selector-class">.execute</span>(ThreadPoolTaskExecutor<span class="selector-class">.java</span>:<span class="number">324</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CompletableFuture</span><span class="selector-class">.asyncSupplyStage</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">1604</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CompletableFuture</span><span class="selector-class">.supplyAsync</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">1830</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.aop</span><span class="selector-class">.interceptor</span><span class="selector-class">.AsyncExecutionAspectSupport</span><span class="selector-class">.doSubmit</span>(AsyncExecutionAspectSupport<span class="selector-class">.java</span>:<span class="number">274</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.aop</span><span class="selector-class">.interceptor</span><span class="selector-class">.AsyncExecutionInterceptor</span><span class="selector-class">.invoke</span>(AsyncExecutionInterceptor<span class="selector-class">.java</span>:<span class="number">129</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.aop</span><span class="selector-class">.framework</span><span class="selector-class">.ReflectiveMethodInvocation</span><span class="selector-class">.proceed</span>(ReflectiveMethodInvocation<span class="selector-class">.java</span>:<span class="number">186</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.aop</span><span class="selector-class">.framework</span>.CglibAopProxy<span class="variable">$CglibMethodInvocation</span><span class="selector-class">.proceed</span>(CglibAopProxy<span class="selector-class">.java</span>:<span class="number">750</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.aop</span><span class="selector-class">.framework</span>.CglibAopProxy<span class="variable">$DynamicAdvisedInterceptor</span><span class="selector-class">.intercept</span>(CglibAopProxy<span class="selector-class">.java</span>:<span class="number">692</span>)</span><br><span class="line">	at com<span class="selector-class">.didispace</span><span class="selector-class">.chapter78</span>.AsyncTasks$<span class="variable">$EnhancerBySpringCGLIB</span>$<span class="variable">$c7e8d57b</span><span class="selector-class">.doTaskOne</span>(&lt;generated&gt;)</span><br><span class="line">	at com<span class="selector-class">.didispace</span><span class="selector-class">.chapter78</span><span class="selector-class">.Chapter78ApplicationTests</span><span class="selector-class">.test2</span>(Chapter78ApplicationTests<span class="selector-class">.java</span>:<span class="number">51</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">62</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">498</span>)</span><br><span class="line">	at org<span class="selector-class">.junit</span><span class="selector-class">.platform</span><span class="selector-class">.commons</span><span class="selector-class">.util</span><span class="selector-class">.ReflectionUtils</span><span class="selector-class">.invokeMethod</span>(ReflectionUtils<span class="selector-class">.java</span>:<span class="number">688</span>)</span><br><span class="line">	at org<span class="selector-class">.junit</span><span class="selector-class">.jupiter</span><span class="selector-class">.engine</span><span class="selector-class">.execution</span><span class="selector-class">.MethodInvocation</span><span class="selector-class">.proceed</span>(MethodInvocation<span class="selector-class">.java</span>:<span class="number">60</span>)</span><br><span class="line">	at org<span class="selector-class">.junit</span><span class="selector-class">.jupiter</span><span class="selector-class">.engine</span><span class="selector-class">.execution</span>.InvocationInterceptorChain<span class="variable">$ValidatingInvocation</span><span class="selector-class">.proceed</span>(InvocationInterceptorChain<span class="selector-class">.java</span>:<span class="number">131</span>)</span><br><span class="line">	at org<span class="selector-class">.junit</span><span class="selector-class">.jupiter</span><span class="selector-class">.engine</span><span class="selector-class">.extension</span><span class="selector-class">.TimeoutExtension</span><span class="selector-class">.intercept</span>(TimeoutExtension<span class="selector-class">.java</span>:<span class="number">149</span>)</span><br><span class="line">	......</span><br><span class="line">	at org<span class="selector-class">.junit</span><span class="selector-class">.platform</span><span class="selector-class">.launcher</span><span class="selector-class">.core</span><span class="selector-class">.DefaultLauncher</span><span class="selector-class">.execute</span>(DefaultLauncher<span class="selector-class">.java</span>:<span class="number">75</span>)</span><br><span class="line">	at com<span class="selector-class">.intellij</span><span class="selector-class">.junit5</span><span class="selector-class">.JUnit5IdeaTestRunner</span><span class="selector-class">.startRunnerWithArgs</span>(JUnit5IdeaTestRunner<span class="selector-class">.java</span>:<span class="number">71</span>)</span><br><span class="line">	at com<span class="selector-class">.intellij</span><span class="selector-class">.rt</span><span class="selector-class">.junit</span>.IdeaTestRunner<span class="variable">$Repeater</span><span class="selector-class">.startRunnerWithArgs</span>(IdeaTestRunner<span class="selector-class">.java</span>:<span class="number">33</span>)</span><br><span class="line">	at com<span class="selector-class">.intellij</span><span class="selector-class">.rt</span><span class="selector-class">.junit</span><span class="selector-class">.JUnitStarter</span><span class="selector-class">.prepareStreamsAndStart</span>(JUnitStarter<span class="selector-class">.java</span>:<span class="number">235</span>)</span><br><span class="line">	at com<span class="selector-class">.intellij</span><span class="selector-class">.rt</span><span class="selector-class">.junit</span><span class="selector-class">.JUnitStarter</span><span class="selector-class">.main</span>(JUnitStarter<span class="selector-class">.java</span>:<span class="number">54</span>)</span><br><span class="line">Caused by: java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.RejectedExecutionException</span>: Task java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.CompletableFuture<span class="variable">$AsyncSupply</span>@<span class="number">64968732</span> rejected from java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor@<span class="number">3</span>e1a3801<span class="selector-attr">[Running, pool size = 2, active threads = 2, queued tasks = 2, completed tasks = 0]</span></span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$AbortPolicy</span><span class="selector-class">.rejectedExecution</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">2063</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.reject</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">830</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.execute</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1379</span>)</span><br><span class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.scheduling</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolTaskExecutor</span><span class="selector-class">.execute</span>(ThreadPoolTaskExecutor<span class="selector-class">.java</span>:<span class="number">321</span>)</span><br><span class="line">	... <span class="number">74</span> more</span><br></pre></td></tr></table></figure>
<p>从异常信息<code>org.springframework.core.task.TaskRejectedException: Executor [java.util.concurrent.ThreadPoolExecutor@3e1a3801[Running, pool size = 2, active threads = 2, queued tasks = 2, completed tasks = 0]] did not accept task:</code>中，可以很明确的知道，第5个任务因为超过了执行线程+缓冲队列长度，而被拒绝了。</p>
<p>所以，默认情况下，线程池的拒绝策略是：<strong>当线程池队列满了，会丢弃这个任务，并抛出异常。</strong></p>
<h2 id="配置拒绝策略"><a href="#配置拒绝策略" class="headerlink" title="配置拒绝策略"></a>配置拒绝策略</h2><p>虽然线程池有默认的拒绝策略，但实际开发过程中，有些业务场景，直接拒绝的策略往往并不适用，有时候我们可能会选择舍弃最早开始执行而未完成的任务、也可能会选择舍弃刚开始执行而未完成的任务等更贴近业务需要的策略。所以，为线程池配置其他拒绝策略或自定义拒绝策略是很常见的需求，那么这个要怎么实现呢？</p>
<p>下面就来具体说说今天的正题，如何为线程池配置拒绝策略、如何自定义拒绝策略。</p>
<p>看下面这段代码的最后一行，<code>setRejectedExecutionHandler</code>方法就是为线程池设置拒绝策略的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//...其他线程池配置</span></span><br><span class="line"></span><br><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br></pre></td></tr></table></figure>
<p>在<code>ThreadPoolExecutor</code>中提供了4种线程的策略可以供开发者直接使用，你只需要像下面这样设置即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbortPolicy策略</span></span><br><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br><span class="line"></span><br><span class="line"><span class="comment">// DiscardPolicy策略</span></span><br><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());</span><br><span class="line"></span><br><span class="line"><span class="comment">// DiscardOldestPolicy策略</span></span><br><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy());</span><br><span class="line"></span><br><span class="line"><span class="comment">// CallerRunsPolicy策略</span></span><br><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br></pre></td></tr></table></figure>
<p>这四个策略对应的含义分别是：</p>
<ul>
<li>  AbortPolicy策略：默认策略，如果线程池队列满了丢掉这个任务并且抛出RejectedExecutionException异常。</li>
<li>  DiscardPolicy策略：如果线程池队列满了，会直接丢掉这个任务并且不会有任何异常。</li>
<li>  DiscardOldestPolicy策略：如果队列满了，会将最早进入队列的任务删掉腾出空间，再尝试加入队列。</li>
<li>  CallerRunsPolicy策略：如果添加到线程池失败，那么主线程会自己去执行该任务，不会等待线程池中的线程去执行。</li>
</ul>
<p>而如果你要自定义一个拒绝策略，那么可以这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">RejectedExecutionHandler</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="comment">// 拒绝策略的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然如果你喜欢用Lamba表达式，也可以这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">executor.setRejectedExecutionHandler((r, executor1) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 拒绝策略的逻辑</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>好了，今天的学习就到这里！</p>
<p>如果您学习过程中如遇困难？可以加入我们超高质量的<a target="_blank" rel="noopener" href="https://blog.didispace.com/join-group-spring/index.html">Spring技术交流群</a>，参与交流与讨论，更好的学习与进步！更多<a target="_blank" rel="noopener" href="http://blog.didispace.com/spring-boot-learning-2x/">Spring Boot教程可以点击直达！</a>，欢迎收藏与转发支持！</p>
<h2 id="代码示例-3"><a href="#代码示例-3" class="headerlink" title="代码示例"></a>代码示例</h2><p>本文的完整工程可以查看下面仓库中<code>2.x</code>目录下的<code>chapter7-8</code>工程：</p>
<ul>
<li>  Github：<a target="_blank" rel="noopener" href="https://github.com/dyc87112/SpringBoot-Learning/tree/master/2.x">https://github.com/dyc87112/SpringBoot-Learning/</a></li>
<li>  Gitee：<a target="_blank" rel="noopener" href="https://gitee.com/didispace/SpringBoot-Learning/tree/master/2.x">https://gitee.com/didispace/SpringBoot-Learning/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://moqiang02.github.io/2022/10/05/SpringBoot%E4%BD%BF%E7%94%A8-Async%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/" data-id="cla0v660k010og0v14txsg9eh" data-title="SpringBoot使用@Async实现异步任务" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/10/06/SpringBoot%E5%AE%9E%E7%8E%B0%E5%9B%BA%E5%AE%9A%E5%8A%A8%E6%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          SpringBoot实现固定、动态定时任务和延迟任务
        
      </div>
    </a>
  
  
    <a href="/2022/10/02/Springboot%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">Springboot常用注解</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">255</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/apache/">apache</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/flutter/">flutter</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github%E5%8D%9A%E5%AE%A2/">github博客</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html-css/">html+css</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iis/">iis</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">84</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">124</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/memcached/">memcached</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">74</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs/">nodejs</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">185</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E5%AE%83/">其它</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/">开源项目</a><span class="category-list-count">73</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E9%9A%8F%E7%AC%94/">生活随笔</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/">量化交易</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AndroidStudio/" style="font-size: 13.16px;">AndroidStudio</a> <a href="/tags/AndroidUI/" style="font-size: 20px;">AndroidUI</a> <a href="/tags/Android%E4%BA%8B%E4%BB%B6%E6%8B%A6%E6%88%AA/" style="font-size: 11.05px;">Android事件拦截</a> <a href="/tags/Android%E5%BC%80%E6%BA%90/" style="font-size: 16.84px;">Android开源</a> <a href="/tags/CI/" style="font-size: 15.26px;">CI</a> <a href="/tags/CURL/" style="font-size: 12.63px;">CURL</a> <a href="/tags/DEDE/" style="font-size: 17.37px;">DEDE</a> <a href="/tags/Docker/" style="font-size: 14.21px;">Docker</a> <a href="/tags/Flask/" style="font-size: 10.53px;">Flask</a> <a href="/tags/JavaSE/" style="font-size: 18.42px;">JavaSE</a> <a href="/tags/Laravel/" style="font-size: 16.84px;">Laravel</a> <a href="/tags/Maven/" style="font-size: 11.58px;">Maven</a> <a href="/tags/MybatisPlus/" style="font-size: 11.05px;">MybatisPlus</a> <a href="/tags/Puppeteer/" style="font-size: 14.74px;">Puppeteer</a> <a href="/tags/SVN/" style="font-size: 10px;">SVN</a> <a href="/tags/Selenium/" style="font-size: 11.58px;">Selenium</a> <a href="/tags/SpringBoot/" style="font-size: 19.47px;">SpringBoot</a> <a href="/tags/Thinkphp/" style="font-size: 10px;">Thinkphp</a> <a href="/tags/UEditor/" style="font-size: 11.58px;">UEditor</a> <a href="/tags/VMware/" style="font-size: 12.11px;">VMware</a> <a href="/tags/Vue/" style="font-size: 18.95px;">Vue</a> <a href="/tags/WebSocket/" style="font-size: 12.63px;">WebSocket</a> <a href="/tags/ecshop/" style="font-size: 14.21px;">ecshop</a> <a href="/tags/scrapy/" style="font-size: 13.68px;">scrapy</a> <a href="/tags/smarty/" style="font-size: 12.11px;">smarty</a> <a href="/tags/socket/" style="font-size: 14.21px;">socket</a> <a href="/tags/sphinx/" style="font-size: 11.58px;">sphinx</a> <a href="/tags/vagrant/" style="font-size: 12.11px;">vagrant</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 11.05px;">微服务</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" style="font-size: 15.26px;">数据传输</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 11.58px;">正则</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 15.79px;">消息队列</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 17.89px;">爬虫</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 16.32px;">集群</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/08/27/%E5%88%A9%E7%94%A8Jenkins%E4%B8%8EDocker%E5%AE%9E%E7%8E%B0Spring-Boot%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E4%B9%8B%E9%81%93/">利用Jenkins与Docker实现Spring Boot项目的自动化部署之道</a>
          </li>
        
          <li>
            <a href="/2025/08/27/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%AD%E5%90%8E%E7%AB%AF%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/">Nginx负载均衡中后端节点服务器健康检查</a>
          </li>
        
          <li>
            <a href="/2025/06/19/%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82Vue%E4%B8%AD%E7%9A%84Mixin%E6%B7%B7%E5%85%A5/">彻底搞懂Vue中的Mixin混入</a>
          </li>
        
          <li>
            <a href="/2025/03/14/%E5%A6%82%E4%BD%95%E5%8F%91%E5%B8%83jar%E5%8C%85%E5%88%B0maven%E4%B8%AD%E5%A4%AE%E4%BB%93%E5%BA%93/">如何发布jar包到maven中央仓库</a>
          </li>
        
          <li>
            <a href="/2025/03/14/%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%EF%BC%9F/">怎么使用Redis实现一个延时队列？</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 moqiang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>

<!-- rex -->

<script src="/js/toc.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>